# 违规位置定位功能说明

## 功能概述

在违规记录添加页面（`add-violation.vue`）中新增了**获取当前位置**的功能，用户可以通过点击按钮自动获取当前位置信息，无需手动输入。

## 功能特性

### 1. 自动定位
- 点击"获取当前位置"按钮，自动获取当前GPS定位
- 使用 **GCJ-02国测局坐标系**（适用于国内地图）
- 支持自动解析地址信息（如果平台支持）

### 2. 地址显示
- 优先显示详细地址（省、市、区、街道、门牌号、POI名称）
- 如果无法获取详细地址，则显示经纬度坐标
- 支持手动修改定位结果

### 3. 用户体验
- 定位过程显示加载提示
- 定位成功显示成功提示
- 定位失败显示详细错误信息
- 支持清空已获取的位置信息

## 使用方法

### 基本使用
1. 在违规位置输入框下方，点击**"获取当前位置"**按钮
2. 等待定位完成（通常需要1-3秒）
3. 定位成功后，位置信息会自动填入输入框
4. 可以根据需要手动修改位置信息
5. 如需重新定位，点击清空按钮后再次点击定位按钮

### 界面说明
```
违规位置
┌────────────────────────────────┐
│ [输入框：请手动输入具体违规位置]  [×] │
└────────────────────────────────┘
┌────────────────────────────────┐
│ [📍] 获取当前位置                │  ← 点击此按钮获取定位
└────────────────────────────────┘
```

## 权限配置

### 1. manifest.json 配置

在 `manifest.json` 中需要配置以下权限：

```json
{
  "mp-weixin": {
    "permission": {
      "scope.userLocation": {
        "desc": "你的位置信息将用于记录违规位置"
      }
    }
  },
  "app-plus": {
    "distribute": {
      "android": {
        "permissions": [
          "<uses-permission android:name=\"android.permission.ACCESS_COARSE_LOCATION\"/>",
          "<uses-permission android:name=\"android.permission.ACCESS_FINE_LOCATION\"/>"
        ]
      }
    }
  },
  "h5": {
    "devServer": {
      "https": true
    }
  }
}
```

### 2. 平台差异说明

| 平台 | 支持情况 | 说明 |
|------|---------|------|
| 微信小程序 | ✅ | 需要用户授权位置权限 |
| H5 | ✅ | 需要HTTPS环境，部分浏览器需要用户授权 |
| App | ✅ | 需要配置定位权限，Android需要动态申请权限 |

## 技术实现

### 核心API
使用 `uni.getLocation()` API 获取位置信息：

```javascript
const res = await uni.getLocation({
  type: 'gcj02',      // 国测局坐标系
  geocode: true,      // 启用地址解析
  altitude: false     // 不需要高度信息
});
```

### 返回数据结构
```javascript
{
  latitude: 45.7597,        // 纬度
  longitude: 126.6424,      // 经度
  speed: 0,                 // 速度
  accuracy: 65,             // 位置精度
  address: {                // 地址信息（如果支持）
    province: "黑龙江省",
    city: "哈尔滨市",
    district: "香坊区",
    street: "和兴路",
    streetNum: "26号",
    poiName: "东北林业大学"
  }
}
```

### 地址解析逻辑
1. 优先使用平台返回的 `address` 对象
2. 拼接完整地址：省 + 市 + 区 + 街道 + 门牌号 + POI名称
3. 如果没有地址信息，使用经纬度格式：`经度:126.642400, 纬度:45.759700`

## 错误处理

### 常见错误及解决方案

| 错误类型 | 原因 | 解决方案 |
|---------|------|---------|
| 用户拒绝授权 | 用户未授予位置权限 | 引导用户在设置中开启位置权限 |
| 定位超时 | GPS信号弱或网络问题 | 建议移至空旷地带或检查网络 |
| 系统定位服务未开启 | 手机GPS未打开 | 提示用户开启手机定位服务 |
| HTTPS问题 | H5环境未使用HTTPS | 部署到HTTPS服务器 |

### 错误提示示例
```javascript
{
  title: '定位失败',
  content: '无法获取当前位置，请检查定位权限或手动输入位置'
}
```

## 进阶功能（可选）

### 腾讯地图逆地址解析

如需更精确的地址信息，可以集成腾讯地图逆地址解析API：

1. **申请腾讯地图开发者Key**
   - 访问：https://lbs.qq.com/
   - 注册并创建应用
   - 获取开发者Key

2. **配置Key**
   在 `manifest.json` 中配置：
   ```json
   {
     "h5": {
       "sdkConfigs": {
         "maps": {
           "qqmap": {
             "key": "YOUR-KEY-HERE"
           }
         }
       }
     }
   }
   ```

3. **使用逆地址解析**
   修改 `reverseGeocoding()` 方法，调用腾讯地图Web Service API：
   ```javascript
   async reverseGeocoding(latitude, longitude) {
     const key = 'YOUR-KEY-HERE';
     const url = `https://apis.map.qq.com/ws/geocoder/v1/?location=${latitude},${longitude}&key=${key}`;
     
     try {
       const res = await uni.request({ url });
       if (res.data.status === 0) {
         const result = res.data.result;
         this.formData.location = result.address;
       }
     } catch (error) {
       console.error('逆地址解析失败:', error);
     }
   }
   ```

### 地图选点功能

如需更精确的位置选择，可以集成地图选点功能：

参考：https://lbs.qq.com/miniProgram/demoCenter/wxGuide/plugin/locationPicker

```javascript
// 打开地图选点
uni.chooseLocation({
  success: (res) => {
    console.log('位置信息:', res);
    this.formData.location = res.address + res.name;
  }
});
```

## 测试建议

### 功能测试
1. ✅ 点击定位按钮，验证是否正常获取位置
2. ✅ 测试定位失败情况的错误提示
3. ✅ 测试手动修改定位结果
4. ✅ 测试清空位置功能
5. ✅ 测试拒绝授权后的处理

### 兼容性测试
1. ✅ 微信小程序环境测试
2. ✅ H5浏览器环境测试（Chrome、Safari、Firefox）
3. ✅ Android App测试
4. ✅ iOS App测试

### 性能测试
1. ✅ 定位速度（应在3秒内完成）
2. ✅ 定位精度（误差应在100米以内）
3. ✅ 重复定位测试

## 注意事项

1. **权限说明**
   - 首次使用需要用户授权位置权限
   - 建议在用户点击定位按钮时再请求权限，避免启动时就请求

2. **精度说明**
   - GPS定位精度受环境影响（室内、高楼、隧道等会影响精度）
   - 建议在室外空旷地带使用以获得最佳精度

3. **坐标系说明**
   - 使用GCJ-02坐标系（国测局坐标，火星坐标系）
   - 与高德地图、腾讯地图兼容
   - 如需使用百度地图，需要进行坐标转换

4. **隐私保护**
   - 位置信息仅用于记录违规位置
   - 不会上传到第三方服务器
   - 仅在用户主动点击时获取

5. **备用方案**
   - 如果定位失败，用户仍可手动输入位置
   - 建议提供常用位置的快捷选择功能

## 更新日志

### v1.0.0 (2025-10-07)
- ✅ 新增获取当前位置功能
- ✅ 支持自动地址解析
- ✅ 优化用户体验和错误提示
- ✅ 添加美观的定位按钮UI

## 参考文档

1. [uni-app 定位API文档](https://uniapp.dcloud.net.cn/api/location/location.html)
2. [uni-app 地图组件文档](https://uniapp.dcloud.net.cn/component/map.html)
3. [腾讯地图位置选择器](https://lbs.qq.com/miniProgram/demoCenter/wxGuide/plugin/locationPicker)
4. [腾讯地图Web Service API](https://lbs.qq.com/service/webService/webServiceGuide/webServiceGcoder)

## 技术支持

如有问题，请联系开发团队或参考以上文档。

