# 拉黑阈值提醒功能说明

## 功能概述
在添加违规记录后，系统会自动查询该车辆距离拉黑阈值还有几次违规，并在提交成功提示中显示详细信息，提醒用户当前违规状态。

## 实现内容

### 1. 后端接口（ViolationsController.java）
新增接口：`GET /parking/violations/threshold-remaining/{plateNumber}`

**功能：**
- 查询指定车牌号的违规统计信息
- 计算距离拉黑阈值还有几次违规
- 返回完整的违规统计和拉黑配置信息

**请求参数：**
- `plateNumber`（路径参数）：车牌号
- `parkName`（查询参数，可选）：停车场名称，默认"东北林业大学"

**返回数据：**
```json
{
  "code": 200,
  "data": {
    "plateNumber": "黑A12345",
    "currentViolationCount": 3,
    "maxViolationCount": 5,
    "remainingCount": 2,
    "willBeBlacklisted": false,
    "blacklistType": "违章黑名单",
    "isPermanent": true
  }
}
```

**字段说明：**
- `currentViolationCount`：当前未处理违规次数
- `maxViolationCount`：拉黑阈值
- `remainingCount`：距离拉黑还有几次（最小为0）
- `willBeBlacklisted`：是否已达到拉黑阈值

### 2. 前端实现（add-violation.vue）

#### 新增方法
1. **checkBlacklistThreshold(plateNumber)**
   - 调用后端接口查询拉黑阈值信息
   - 处理查询结果和异常情况

#### 修改方法
2. **showSubmitSuccessModal(result)** 改为 async 方法
   - 在显示成功提示前查询拉黑阈值
   - 将阈值信息添加到提示内容中
   - 根据违规状态显示不同的警告信息

## 使用场景

### 场景1：车辆未达到拉黑阈值
提交违规记录后，会显示：
```
违规记录已成功提交
记录编号：12345
信用分影响：5分
创建者：巡逻员张三

 当前违规统计：
车牌号：黑A12345
当前违规次数：3
拉黑阈值：5
⚠️ 还有 2 次违规将被拉黑
```

### 场景2：车辆已达到拉黑阈值
提交违规记录后，会显示：
```
违规记录已成功提交
记录编号：12346
信用分影响：5分
创建者：巡逻员张三

 当前违规统计：
车牌号：黑A12345
当前违规次数：5
拉黑阈值：5
⚠️ 该车辆已达到拉黑阈值，将被自动拉黑！
```

## 技术特点

1. **异步查询**：不影响违规记录提交流程，查询失败时静默处理
2. **友好提示**：清晰显示违规统计和剩余次数
3. **实时统计**：每次提交后立即查询最新数据
4. **智能警告**：根据违规状态显示不同级别的警告信息

## 测试步骤

### 测试1：正常提交并查看阈值提醒
1. 打开违规登记页面
2. 输入车牌号：黑A12345
3. 选择违规类型和填写必要信息
4. 点击提交
5. 查看成功提示中是否显示违规统计信息

### 测试2：测试接近阈值的提醒
1. 选择一个违规次数接近阈值的车辆（如已违规4次，阈值5次）
2. 提交新的违规记录
3. 确认提示中显示"还有 1 次违规将被拉黑"

### 测试3：测试达到阈值的提醒
1. 选择一个违规次数等于或超过阈值的车辆
2. 提交新的违规记录
3. 确认提示中显示"该车辆已达到拉黑阈值，将被自动拉黑！"

### 测试4：测试接口异常处理
1. 在网络不稳定的情况下提交违规记录
2. 确认即使阈值查询失败，违规记录仍能正常提交
3. 查看控制台是否有相应的错误日志

## 注意事项

1. 阈值查询失败不会影响违规记录的提交
2. 剩余次数的计算基于未处理的违规记录
3. 拉黑阈值配置在后台管理系统中设置
4. 提醒信息仅作参考，实际拉黑由后端自动执行

## 相关配置

- 违规阈值配置：在管理后台的"违规配置"中设置
- 默认阈值：5次
- 阈值范围：3-10次
- 后端服务地址：https://www.xuerparking.cn:8543

## 文件修改清单

### 后端
- `ViolationsController.java`：新增 `getThresholdRemaining()` 接口

### 前端
- `add-violation.vue`：
  - 修改 `showSubmitSuccessModal()` 方法（改为 async）
  - 新增 `checkBlacklistThreshold()` 方法

## 版本信息
- 实现日期：2025-10-06
- 版本：v1.0.0
- 状态：已完成
