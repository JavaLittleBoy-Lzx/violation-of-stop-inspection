# 停车管理系统改造为违停巡检系统详细方案

## 项目概述
将现有的基于微信授权的停车管理系统改造为使用账号密码登录的违停巡检系统。

---

## 一、需要删除的文件清单

### 1.1 微信授权相关文件
```
📁 pages/auth/
├── phone-auth.vue                 ❌ 删除 - 微信手机号授权页面
├── phone-auth.js                  ❌ 删除 - 授权逻辑

📁 pages/webview/
├── wechat-auth.vue               ❌ 删除 - 微信授权页面
├── direct-auth.vue               ❌ 删除 - 直接授权页面

📁 utils/
├── wechat-union.js               ❌ 删除 - 微信UnionID工具类
```

### 1.2 复杂角色权限系统文件
```
📁 utils/
├── permission.js                 ❌ 删除 - 权限管理工具类
├── dynamicTabBar.js             ❌ 删除 - 动态TabBar管理器
├── auth.js                      ⚠️  重构 - 认证工具类（大幅修改）

📁 mixins/
├── auth.js                      ❌ 删除 - 认证混入

📁 api/
├── auth.js                      ⚠️  重构 - 认证API（改为账号密码）
```

### 1.3 角色相关页面
```
📁 pagesD/auth/
├── visitor-apply.vue            ❌ 删除 - 访客申请页面

📁 pages/violation/
├── owner-violation.vue          ❌ 删除 - 业主违规页面
├── owner-new-violation.vue     ❌ 删除 - 业主新违规页面

📁 pages/site/
├── facility.vue                 ❌ 删除 - 审核页面（业主管家专用）
├── approve_detail.vue          ❌ 删除 - 审核详情
├── approve_search.vue          ❌ 删除 - 审核查询
├── approve_transfer.vue        ❌ 删除 - 审核转移
```

### 1.4 测试相关页面
```
📁 pages/test/
├── test-role-switch.vue        ❌ 删除 - 角色切换测试
├── test-tabbar-fix.vue         ❌ 删除 - TabBar测试
├── test-page.vue               ❌ 删除 - 页面测试
```

---

## 二、需要修改的核心文件

### 2.1 项目配置文件

#### `package.json`
```json
{
  "name": "violation-inspection-system",
  "displayName": "违停巡检系统",
  "version": "1.0.0",
  "description": "违停车辆巡检管理系统",
  "keywords": [
    "违停巡检",
    "车辆管理", 
    "违规处理",
    "巡检系统",
    "执法工具"
  ],
  "author": "您的团队",
  "license": "MIT"
}
```

#### `manifest.json`
```json
{
  "name": "违停巡检系统",
  "appid": "__UNI__XXXXXX",
  "description": "违停车辆巡检管理系统",
  "versionName": "1.0.0",
  "mp-weixin": {
    "appid": "移除或更新为新的小程序ID",
    "permission": {
      // 删除微信相关权限
    }
  }
}
```

### 2.2 页面路由配置

#### `pages.json` - 简化路由结构
```json
{
  "pages": [
    {
      "path": "pages/login/login",
      "style": {
        "navigationBarTitleText": "登录",
        "navigationStyle": "custom"
      }
    },
    {
      "path": "pages/violation/list",
      "style": {
        "navigationBarTitleText": "违停记录",
        "enablePullDownRefresh": true
      }
    },
    {
      "path": "pages/violation/add",
      "style": {
        "navigationBarTitleText": "新增违停"
      }
    },
    {
      "path": "pages/violation/detail",
      "style": {
        "navigationBarTitleText": "违停详情"
      }
    },
    {
      "path": "pages/profile/profile",
      "style": {
        "navigationBarTitleText": "个人中心"
      }
    }
  ],
  "tabBar": {
    "color": "#7A7E83",
    "selectedColor": "#0081ff",
    "borderStyle": "black",
    "backgroundColor": "#ffffff",
    "list": [
      {
        "pagePath": "pages/violation/list",
        "iconPath": "static/icons/list.png",
        "selectedIconPath": "static/icons/list-active.png",
        "text": "违停记录"
      },
      {
        "pagePath": "pages/violation/add",
        "iconPath": "static/icons/add.png",
        "selectedIconPath": "static/icons/add-active.png",
        "text": "新增违停"
      },
      {
        "pagePath": "pages/profile/profile",
        "iconPath": "static/icons/profile.png",
        "selectedIconPath": "static/icons/profile-active.png",
        "text": "个人中心"
      }
    ]
  }
}
```

---

## 三、新建文件清单

### 3.1 登录系统
```
📁 pages/login/
├── login.vue                    ✅ 新建 - 账号密码登录页面
├── login.js                     ✅ 新建 - 登录逻辑
```

### 3.2 违停管理页面
```
📁 pages/violation/
├── list.vue                     ✅ 新建 - 违停记录列表
├── add.vue                      ✅ 新建 - 新增违停记录
├── detail.vue                   ✅ 新建 - 违停记录详情
├── edit.vue                     ✅ 新建 - 编辑违停记录
```

### 3.3 简化的工具类
```
📁 utils/
├── auth-simple.js               ✅ 新建 - 简化的认证工具
├── request.js                   ⚠️  修改 - 请求拦截器
├── storage.js                   ✅ 新建 - 本地存储工具
```

### 3.4 API接口
```
📁 api/
├── auth.js                      ✅ 重写 - 账号密码登录API
├── violation.js                 ✅ 新建 - 违停相关API
├── user.js                      ✅ 新建 - 用户相关API
```

---

## 四、详细修改内容

### 4.1 删除微信授权逻辑

#### 删除的认证相关代码片段：
```javascript
// ❌ 删除以下类型的代码
wx.login()
wx.getUserProfile()
wx.getPhoneNumber()
openid、unionid相关逻辑
微信授权相关的所有方法
```

### 4.2 简化用户数据结构

#### 原用户数据结构（删除）：
```javascript
// ❌ 删除复杂的用户结构
{
  isAuthorized: boolean,
  role: 'owner'|'manager'|'visitor'|'pending'|'rejected'|'unregistered',
  roleText: string,
  phone: string,
  openid: string,
  loginTime: timestamp,
  userInfo: {
    id: string,
    username: string,
    usercode: string,
    community: string,
    permissions: Array
  }
}
```

#### 新用户数据结构（创建）：
```javascript
// ✅ 新的简化用户结构
{
  id: string,
  username: string,
  name: string,
  phone: string,
  department: string,
  position: string,
  loginTime: timestamp,
  token: string
}
```

### 4.3 权限系统简化

#### 删除的权限常量：
```javascript
// ❌ 删除复杂的权限定义
export const PERMISSIONS = {
  APPOINTMENT_CREATE: 'appointment.create',
  APPOINTMENT_QUERY: 'appointment.query',
  VIOLATION_VIEW_OWN: 'violation.view.own',
  VIOLATION_MANAGE: 'violation.manage',
  // ... 所有复杂权限定义
}

export const ROLE_PERMISSIONS = {
  owner: [...],
  manager: [...],
  visitor: [...]
}
```

#### 新的简化权限：
```javascript
// ✅ 简化的权限（所有用户都是巡检员）
export const USER_PERMISSIONS = [
  'violation.view',
  'violation.add',
  'violation.edit',
  'violation.delete',
  'profile.view',
  'profile.edit'
]
```

### 4.4 TabBar简化

#### 删除的动态TabBar逻辑：
```javascript
// ❌ 删除动态TabBar管理器
class DynamicTabBarManager {
  static tabBarConfigs = {
    owner: [...],
    manager: [...],
    visitor: [...]
  }
  static async setTabBarByRole(role) {...}
}
```

#### 新的固定TabBar：
```javascript
// ✅ 固定的TabBar配置（在pages.json中）
"tabBar": {
  "list": [
    {
      "pagePath": "pages/violation/list",
      "text": "违停记录"
    },
    {
      "pagePath": "pages/violation/add", 
      "text": "新增违停"
    },
    {
      "pagePath": "pages/profile/profile",
      "text": "个人中心"
    }
  ]
}
```

---

## 五、API接口改造

### 5.1 登录接口改造

#### 原登录接口（删除）：
```javascript
// ❌ 删除微信授权登录
export const wxLogin = (code, phone) => {
  return request.post('/auth/wx-login', { code, phone })
}

export const getUnionId = (openid) => {
  return request.get('/auth/union-id', { openid })
}
```

#### 新登录接口（创建）：
```javascript
// ✅ 新的账号密码登录
export const login = (username, password) => {
  return request.post('/auth/login', { username, password })
}

export const logout = () => {
  return request.post('/auth/logout')
}

export const refreshToken = () => {
  return request.post('/auth/refresh-token')
}
```

### 5.2 用户信息接口

```javascript
// ✅ 简化的用户接口
export const getUserInfo = () => {
  return request.get('/user/info')
}

export const updateUserInfo = (data) => {
  return request.put('/user/info', data)
}

export const changePassword = (oldPassword, newPassword) => {
  return request.put('/user/password', { oldPassword, newPassword })
}
```

### 5.3 违停管理接口

```javascript
// ✅ 新的违停管理接口
export const getViolationList = (params) => {
  return request.get('/violation/list', { params })
}

export const getViolationDetail = (id) => {
  return request.get(`/violation/${id}`)
}

export const addViolation = (data) => {
  return request.post('/violation/add', data)
}

export const updateViolation = (id, data) => {
  return request.put(`/violation/${id}`, data)
}

export const deleteViolation = (id) => {
  return request.delete(`/violation/${id}`)
}
```

---

## 六、数据库结构调整

### 6.1 删除的数据表
```sql
-- ❌ 删除角色权限相关表
DROP TABLE IF EXISTS user_roles;
DROP TABLE IF EXISTS role_permissions;
DROP TABLE IF EXISTS permissions;
DROP TABLE IF EXISTS roles;
DROP TABLE IF EXISTS wx_auth_records;
```

### 6.2 新的用户表结构
```sql
-- ✅ 简化的用户表
CREATE TABLE users (
  id VARCHAR(32) PRIMARY KEY,
  username VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名',
  password VARCHAR(255) NOT NULL COMMENT '密码',
  name VARCHAR(50) NOT NULL COMMENT '姓名',
  phone VARCHAR(20) COMMENT '手机号',
  department VARCHAR(100) COMMENT '部门',
  position VARCHAR(50) COMMENT '职位',
  status TINYINT DEFAULT 1 COMMENT '状态：1启用，0禁用',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 6.3 违停记录表
```sql
-- ✅ 违停记录表
CREATE TABLE violations (
  id VARCHAR(32) PRIMARY KEY,
  plate_number VARCHAR(20) NOT NULL COMMENT '车牌号',
  violation_type VARCHAR(50) NOT NULL COMMENT '违停类型',
  location VARCHAR(200) NOT NULL COMMENT '违停地点',
  description TEXT COMMENT '违停描述',
  photo_urls JSON COMMENT '违停照片',
  inspector_id VARCHAR(32) NOT NULL COMMENT '巡检员ID',
  inspector_name VARCHAR(50) NOT NULL COMMENT '巡检员姓名',
  violation_time TIMESTAMP NOT NULL COMMENT '违停时间',
  status VARCHAR(20) DEFAULT 'pending' COMMENT '处理状态',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (inspector_id) REFERENCES users(id)
);
```

---

## 七、实施步骤

### 第一阶段：清理删除
1. **备份整个项目**
2. **删除微信授权相关文件**
   - 删除 `pages/auth/phone-auth.vue`
   - 删除 `pages/webview/` 目录下的授权页面
   - 删除 `utils/wechat-union.js`

3. **删除角色权限系统文件**
   - 删除 `utils/permission.js`
   - 删除 `utils/dynamicTabBar.js`
   - 删除 `mixins/auth.js`

4. **删除角色相关页面**
   - 删除 `pagesD/auth/visitor-apply.vue`
   - 删除业主、管家专用页面

### 第二阶段：创建新功能
1. **创建登录页面**
   - 新建 `pages/login/login.vue`
   - 实现账号密码登录表单

2. **创建违停管理页面**
   - 新建违停记录列表页面
   - 新建违停记录添加页面
   - 新建违停记录详情页面

3. **重写认证工具类**
   - 简化 `utils/auth.js`
   - 新建 `utils/storage.js`

### 第三阶段：配置调整
1. **修改项目配置**
   - 更新 `package.json`
   - 更新 `manifest.json`
   - 简化 `pages.json`

2. **修改API接口**
   - 重写 `api/auth.js`
   - 新建 `api/violation.js`

### 第四阶段：测试验证
1. **功能测试**
   - 登录功能测试
   - 违停记录管理测试
   - 页面跳转测试

2. **兼容性测试**
   - 不同设备测试
   - 网络异常测试

---

## 八、注意事项

### 8.1 数据迁移
- 如果需要保留现有用户数据，需要制定数据迁移方案
- 现有的预约记录可以考虑转换为违停记录的历史数据

### 8.2 安全性考虑
- 实现密码加密存储
- 添加登录失败次数限制
- 实现token过期刷新机制

### 8.3 用户体验
- 保持页面设计风格的一致性
- 添加适当的加载状态提示
- 实现离线数据缓存

### 8.4 后续扩展
- 预留GPS定位功能接口
- 预留图片上传功能
- 预留统计报表功能

---

## 九、完成后的项目结构

```
violation-inspection-system/
├── pages/
│   ├── login/
│   │   └── login.vue                # 登录页面
│   ├── violation/
│   │   ├── list.vue                 # 违停记录列表
│   │   ├── add.vue                  # 新增违停记录
│   │   ├── detail.vue               # 违停记录详情
│   │   └── edit.vue                 # 编辑违停记录
│   └── profile/
│       └── profile.vue              # 个人中心
├── api/
│   ├── auth.js                      # 认证API
│   ├── violation.js                 # 违停API
│   └── user.js                      # 用户API
├── utils/
│   ├── auth-simple.js               # 简化认证工具
│   ├── request.js                   # 请求工具
│   └── storage.js                   # 存储工具
├── static/                          # 静态资源
├── components/                      # 公共组件
├── pages.json                       # 页面配置
├── manifest.json                    # 应用配置
└── package.json                     # 项目配置
```

这个改造方案将彻底简化项目结构，移除复杂的角色权限系统，专注于违停巡检的核心功能。 