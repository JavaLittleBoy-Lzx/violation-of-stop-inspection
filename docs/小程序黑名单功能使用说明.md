# 小程序黑名单功能使用说明

## 📱 功能概述

在违规登记小程序中新增了完整的黑名单管理功能，包括：
- ✅ 黑名单类型选择（从后端动态加载）
- ✅ 拉黑时长设置（永久拉黑 / 临时拉黑）
- ✅ 拉黑原因填写
- ✅ 自动提交黑名单信息到后端

---

## 🎯 功能入口

### **权限说明**
- **管理员**：可以看到完整的拉黑设置区域
- **巡逻员**：不显示拉黑设置（无拉黑权限）

### **显示条件**
只有当用户角色为"管理员"时，才会在违规登记页面显示"拉黑设置"区域。

---

## 🖼️ 界面说明

### **1. 拉黑开关**
```
┌─────────────────────────────────────┐
│  🚫 拉黑设置                  [必填] │
├─────────────────────────────────────┤
│  是否拉黑该车辆              [开关]  │
│  拉黑后该车辆将无法再次预约停车      │
└─────────────────────────────────────┘
```
- 管理员必须明确选择是否拉黑
- 如果选择拉黑，下方会展开更多设置项

---

### **2. 黑名单类型选择**（仅在开启拉黑时显示）
```
┌─────────────────────────────────────┐
│  黑名单类型 *   （使用默认类型）     │
│  ┌───────────────────────────────┐  │
│  │ 违规黑名单                 ▼ │  │
│  └───────────────────────────────┘  │
│  ℹ️ 因违规停车被加入黑名单          │
└─────────────────────────────────────┘
```

**黑名单类型来源：**
1. **优先**：从 ACMS 系统获取（调用 4.25 接口）
2. **兜底**：ACMS 未配置时使用默认类型

**默认黑名单类型：**
- 违规黑名单（`default_violation`）
- 安全黑名单（`default_security`）
- 恶意黑名单（`default_malicious`）

**本地兜底类型：**（网络异常时使用）
- 违规黑名单（`local_violation`）
- 安全黑名单（`local_security`）

---

### **3. 拉黑时长选择**（仅在开启拉黑时显示）
```
┌─────────────────────────────────────┐
│  拉黑时长 *                          │
│  ┌─────────────┐ ┌─────────────┐   │
│  │ ● 永久拉黑  │ │ ○ 临时拉黑  │   │
│  └─────────────┘ └─────────────┘   │
└─────────────────────────────────────┘
```

**永久拉黑：**
- 不需要设置时间范围
- 该车辆将永久无法预约停车

**临时拉黑：**（选择后展开时间选择器）
```
┌─────────────────────────────────────┐
│  拉黑时长 *                          │
│  ┌─────────────┐ ┌─────────────┐   │
│  │ ○ 永久拉黑  │ │ ● 临时拉黑  │   │
│  └─────────────┘ └─────────────┘   │
│                                      │
│  开始时间： [2025-10-03      ▼]     │
│  结束时间： [2025-11-02      ▼]     │
└─────────────────────────────────────┘
```
- 需要选择开始和结束日期
- 系统默认设置为：当前日期 ~ 30天后

---

### **4. 拉黑原因**（仅在开启拉黑时显示）
```
┌─────────────────────────────────────┐
│  拉黑原因 *                          │
│  ┌───────────────────────────────┐  │
│  │ 请输入拉黑原因（必填）...     │  │
│  │                               │  │
│  └───────────────────────────────┘  │
│                                      │
│  快速模板：                   [展开] │
│  ┌──────────────┐ ┌──────────────┐ │
│  │ 占用他人车位 │ │ 占用消防通道 │ │
│  └──────────────┘ └──────────────┘ │
└─────────────────────────────────────┘
```

**要求：**
- 至少 5 个字符
- 支持快速模板选择

---

## 🔄 操作流程

### **完整流程：**

```
1️⃣ 输入车牌号
   ↓
2️⃣ 选择违规类型
   ↓
3️⃣ 填写违规信息（地点、照片等）
   ↓
4️⃣ 【管理员】拉黑设置
   ├─ 开启拉黑开关
   ├─ 选择黑名单类型
   ├─ 选择拉黑时长（永久/临时）
   └─ 填写拉黑原因
   ↓
5️⃣ 提交违规记录
```

---

## 📤 提交数据格式

提交到后端的数据包含以下黑名单相关字段：

```javascript
{
  // ... 其他违规信息 ...
  
  // 拉黑基础信息
  "shouldBlacklist": 1,                    // 是否拉黑（1=是，0=否）
  "blacklistReason": "占用消防通道，存在安全隐患",  // 拉黑原因
  
  // 黑名单类型
  "blacklistTypeCode": "703",              // 黑名单类型编码
  "blacklistTypeName": "违规黑名单",        // 黑名单类型名称
  
  // 拉黑时长
  "blacklistDurationType": "temporary",    // 时长类型（permanent/temporary）
  "blacklistStartTime": "2025-10-03",      // 开始时间（临时拉黑时有值）
  "blacklistEndTime": "2025-11-02"         // 结束时间（临时拉黑时有值）
}
```

---

## 🎨 UI 设计特点

### **1. 颜色区分**
- **黑名单类型**：蓝色主题（`#f0f7ff`）
- **拉黑时长**：黄色主题（`#fffbf0`）
- **拉黑原因**：红色主题（`#fff5f5`）

### **2. 交互反馈**
- 选择器点击有缩放动画
- 必填项未填写时有红色边框提示
- 加载状态显示"加载中..."

### **3. 用户体验**
- 默认选中第一个黑名单类型
- 临时拉黑自动设置默认时间范围
- 快速模板一键填充拉黑原因

---

## 🔍 后端接口调用

### **1. 加载黑名单类型**

**触发时机：** 页面加载时（`onLoad`）

**接口地址：** `POST http://localhost:8080/parking/acms/vip/blacklist-types`

**请求参数：**
```json
{
  "parkName": "东北林业大学"
}
```

**成功响应：**
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "blacklistTypes": [
      {
        "code": "703",
        "name": "违规黑名单",
        "vipGroupType": "1",
        "vipType": "2",
        "description": "因违规停车被加入黑名单"
      }
    ],
    "isDefault": false,
    "count": 1
  }
}
```

**错误处理：**
- 网络异常：使用本地兜底数据
- ACMS 未配置：使用后端默认数据
- 其他错误：使用本地兜底数据

---

### **2. 提交违规记录（含黑名单信息）**

**接口地址：** 现有违规记录提交接口

**新增字段：**
- `blacklistTypeCode` - 黑名单类型编码
- `blacklistTypeName` - 黑名单类型名称
- `blacklistDurationType` - 拉黑时长类型
- `blacklistStartTime` - 拉黑开始时间
- `blacklistEndTime` - 拉黑结束时间

---

## ⚙️ 配置说明

### **1. 接口地址配置**
在 `loadBlacklistTypes()` 方法中：
```javascript
url: 'http://localhost:8080/parking/acms/vip/blacklist-types'
```

**生产环境修改：**
```javascript
url: 'https://your-production-domain.com/parking/acms/vip/blacklist-types'
```

---

### **2. 默认时长配置**
在 `onBlacklistDurationTypeChange()` 方法中：
```javascript
const endDate = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
```
- 当前设置：30 天
- 可根据需求调整天数

---

### **3. 本地兜底数据配置**
在 `loadBlacklistTypes()` 方法的 `catch` 块中：
```javascript
this.blacklistTypeOptions = [
  {
    code: 'local_violation',
    name: '违规黑名单',
    description: '因违规停车被加入黑名单'
  },
  {
    code: 'local_security',
    name: '安全黑名单',
    description: '因安全原因被加入黑名单'
  }
];
```

---

## 🐛 调试信息

### **控制台日志输出**

**页面加载时：**
```
📋 [黑名单类型] 开始加载黑名单类型列表...
✅ [黑名单类型] 加载成功: { count: 3, isDefault: false, types: [...] }
```

**权限不足时：**
```
⚠️ [黑名单类型] 当前用户无拉黑权限，跳过加载
```

**加载失败时：**
```
❌ [黑名单类型] 加载失败: Error...
⚠️ [黑名单类型] 使用本地兜底数据
```

**类型选择变更时：**
```
🔄 [黑名单类型] 选择变更: { index: 1, type: {...} }
```

**时长类型变更时：**
```
🔄 [黑名单时长] 类型变更: temporary
🔄 [黑名单时长] 开始时间: 2025-10-03
🔄 [黑名单时长] 结束时间: 2025-11-02
```

---

## ✅ 验证规则

### **必填项检查：**

1. **拉黑决定**
   - 管理员必须明确选择是否拉黑
   - 未选择时提示：`请明确选择是否拉黑该车辆`

2. **黑名单类型**
   - 开启拉黑时自动加载
   - 默认选中第一个

3. **拉黑时长**
   - 默认选择"永久拉黑"
   - 切换到"临时拉黑"时自动设置时间

4. **拉黑原因**
   - 至少 5 个字符
   - 未填写时提示：`请填写拉黑原因（至少5个字符）`

---

## 📝 代码关键点

### **1. 数据结构（data）**
```javascript
// 黑名单类型相关
blacklistTypeOptions: [],              // 黑名单类型列表
selectedBlacklistTypeIndex: 0,         // 当前选中索引
blacklistTypeLoading: false,           // 加载状态
isDefaultBlacklistTypes: false,        // 是否使用默认数据

// 黑名单时长相关
blacklistDurationType: 'permanent',    // 时长类型
blacklistStartTime: '',                // 开始时间
blacklistEndTime: '',                  // 结束时间
```

---

### **2. 关键方法**
- `loadBlacklistTypes()` - 加载黑名单类型
- `onBlacklistTypeChange()` - 类型选择变更
- `onBlacklistDurationTypeChange()` - 时长类型变更
- `onBlacklistStartTimeChange()` - 开始时间变更
- `onBlacklistEndTimeChange()` - 结束时间变更
- `formatDateTime()` - 日期时间格式化

---

### **3. 提交数据构建**
在 `confirmSubmit()` 方法中：
```javascript
blacklistTypeCode: this.blacklistTypeOptions[this.selectedBlacklistTypeIndex].code,
blacklistTypeName: this.blacklistTypeOptions[this.selectedBlacklistTypeIndex].name,
blacklistDurationType: this.blacklistDurationType,
blacklistStartTime: this.blacklistStartTime,
blacklistEndTime: this.blacklistEndTime
```

---

### **4. 表单重置**
在 `resetForm()` 方法中：
```javascript
this.selectedBlacklistTypeIndex = 0;
this.blacklistDurationType = 'permanent';
this.blacklistStartTime = '';
this.blacklistEndTime = '';
```

---

## 🚀 测试建议

### **1. 功能测试**
- [ ] 页面加载时自动加载黑名单类型
- [ ] 管理员可以看到拉黑设置区域
- [ ] 巡逻员看不到拉黑设置区域
- [ ] 开启拉黑后显示类型、时长、原因输入
- [ ] 关闭拉黑后隐藏相关输入项
- [ ] 切换到临时拉黑后显示时间选择器
- [ ] 快速模板可以一键填充拉黑原因
- [ ] 提交时包含完整的黑名单信息

---

### **2. 异常测试**
- [ ] 网络异常时使用本地兜底数据
- [ ] ACMS 未配置时使用后端默认数据
- [ ] 未填写必填项时无法提交
- [ ] 拉黑原因少于 5 个字符时提示错误

---

### **3. 样式测试**
- [ ] 不同主题颜色正确显示
- [ ] 选择器点击有动画效果
- [ ] 必填项未填写时显示红色边框
- [ ] 时间选择器正常弹出

---

## 🔗 相关文件

### **小程序端：**
- `pages/violation/add-violation.vue` - 违规登记页面

### **后端接口：**
- `AcmsVipController.java` - 黑名单类型接口
- `AcmsVipService.java` - 黑名单类型服务

### **文档：**
- `黑名单类型接口说明.md` - 后端接口文档
- `小程序黑名单功能使用说明.md` - 本文档

---

## 💡 后续优化建议

1. **添加黑名单预览**
   - 在提交前显示拉黑信息摘要
   - 让管理员再次确认

2. **支持批量拉黑**
   - 一次性拉黑多个车辆
   - 提高操作效率

3. **黑名单历史记录**
   - 显示该车辆的拉黑历史
   - 避免重复拉黑

4. **拉黑通知**
   - 拉黑成功后发送通知给车主
   - 提醒车主拉黑原因和时长

---

**文档创建时间：** 2025-10-03  
**最后更新：** 2025-10-03  
**维护人员：** System
