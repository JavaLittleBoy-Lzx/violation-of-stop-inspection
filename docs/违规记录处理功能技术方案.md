# è¿è§„è®°å½•å¤„ç†åŠŸèƒ½æŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£

## ğŸ“‹ ç›®å½•
- [ä¸€ã€éœ€æ±‚æ¦‚è¿°](#ä¸€éœ€æ±‚æ¦‚è¿°)
- [äºŒã€æ•°æ®åº“è®¾è®¡](#äºŒæ•°æ®åº“è®¾è®¡)
- [ä¸‰ã€åç«¯å®ç°æ–¹æ¡ˆ](#ä¸‰åç«¯å®ç°æ–¹æ¡ˆ)
- [å››ã€å‰ç«¯å®ç°æ–¹æ¡ˆ](#å››å‰ç«¯å®ç°æ–¹æ¡ˆ)
- [äº”ã€å®æ–½æ­¥éª¤](#äº”å®æ–½æ­¥éª¤)
- [å…­ã€æµ‹è¯•æ–¹æ¡ˆ](#å…­æµ‹è¯•æ–¹æ¡ˆ)

---

## ä¸€ã€éœ€æ±‚æ¦‚è¿°

### 1.1 åŠŸèƒ½ç›®æ ‡

å®ç°è¿è§„è®°å½•çš„å¤„ç†çŠ¶æ€ç®¡ç†ï¼Œæ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š

1. **ç³»ç»Ÿè‡ªåŠ¨æ‹‰é»‘**ï¼šå½“åŒä¸€è½¦ç‰Œè¿è§„æ¬¡æ•°è¾¾åˆ°é…ç½®çš„é˜ˆå€¼ï¼ˆå¦‚3æ¬¡ï¼‰æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨å°†è¯¥è½¦ç‰ŒåŠ å…¥é»‘åå•ï¼Œå¹¶å°†æ‰€æœ‰è¯¥è½¦ç‰Œçš„è¿è§„è®°å½•æ ‡è®°ä¸º"å·²å¤„ç†"
2. **æ‰‹åŠ¨å¤„ç†**ï¼šç®¡ç†å‘˜å¯ä»¥åœ¨åå°æ‰‹åŠ¨å¤„ç†è¿è§„è®°å½•
3. **æ‰‹åŠ¨æ‰¹é‡å¤„ç†**ï¼šç®¡ç†å‘˜å¯ä»¥æ‰¹é‡é€‰æ‹©å¤šæ¡è¿è§„è®°å½•è¿›è¡Œå¤„ç†
4. **ç­›é€‰æŸ¥è¯¢**ï¼šæ”¯æŒæŒ‰å¤„ç†çŠ¶æ€å’Œå¤„ç†æ–¹å¼è¿›è¡Œç­›é€‰
5. **å°ç¨‹åºè¿‡æ»¤**ï¼šå°ç¨‹åºç«¯åªæ˜¾ç¤ºæœªå¤„ç†çš„è¿è§„è®°å½•

### 1.2 æ ¸å¿ƒåŸåˆ™

- âœ… **æ•°æ®ä¸åˆ é™¤**ï¼šæ‰€æœ‰è¿è§„è®°å½•æ°¸ä¹…ä¿ç•™ï¼Œä»…é€šè¿‡çŠ¶æ€å­—æ®µæ ‡è®°
- âœ… **è‡ªåŠ¨åŒ–å¤„ç†**ï¼šç¬¬Næ¬¡è¿è§„æ—¶è‡ªåŠ¨è§¦å‘æ‹‰é»‘å’Œæ‰¹é‡æ ‡è®°
- âœ… **å¯è¿½æº¯æ€§**ï¼šè®°å½•å¤„ç†æ—¶é—´ã€å¤„ç†äººã€å¤„ç†æ–¹å¼

### 1.3 ä¸šåŠ¡æµç¨‹ç¤ºä¾‹

**åœºæ™¯ï¼šé…ç½®ç´¯è®¡3æ¬¡è¿è§„è‡ªåŠ¨æ‹‰é»‘**

```
è½¦ç‰Œå·ï¼šäº¬A12345

ç¬¬1æ¬¡è¿è§„ â†’ åˆ›å»ºè¿è§„è®°å½• â†’ process_status: pending
ç¬¬2æ¬¡è¿è§„ â†’ åˆ›å»ºè¿è§„è®°å½• â†’ process_status: pending
ç¬¬3æ¬¡è¿è§„ â†’ åˆ›å»ºè¿è§„è®°å½• â†’ è§¦å‘è‡ªåŠ¨æ‹‰é»‘
            â†“
    1. æ·»åŠ åˆ°é»‘åå•ï¼ˆblacklistè¡¨ï¼‰
    2. å°†äº¬A12345çš„æ‰€æœ‰3æ¡è¿è§„è®°å½•æ ‡è®°ä¸ºï¼š
       - process_status: processed
       - process_type: auto_blacklist
       - processed_by: SYSTEM
       - process_remark: ç´¯è®¡è¿è§„3æ¬¡ï¼Œç³»ç»Ÿè‡ªåŠ¨æ‹‰é»‘
       - processed_at: 2025-01-31 15:30:00
```

---

## äºŒã€æ•°æ®åº“è®¾è®¡

### 2.1 violations è¡¨å­—æ®µæ–°å¢

åœ¨ `violations` è¡¨ä¸­æ·»åŠ ä»¥ä¸‹5ä¸ªå­—æ®µï¼š

```sql
-- å¤„ç†çŠ¶æ€å­—æ®µ
ALTER TABLE violations 
ADD COLUMN process_status VARCHAR(20) DEFAULT 'pending' 
COMMENT 'å¤„ç†çŠ¶æ€: pending-æœªå¤„ç†, processed-å·²å¤„ç†';

-- å¤„ç†æ–¹å¼å­—æ®µ  
ALTER TABLE violations 
ADD COLUMN process_type VARCHAR(50) DEFAULT NULL 
COMMENT 'å¤„ç†æ–¹å¼: auto_blacklist-ç³»ç»Ÿè‡ªåŠ¨æ‹‰é»‘, manual-æ‰‹åŠ¨å¤„ç†';

-- å¤„ç†æ—¶é—´å­—æ®µ
ALTER TABLE violations 
ADD COLUMN processed_at TIMESTAMP NULL DEFAULT NULL 
COMMENT 'å¤„ç†æ—¶é—´';

-- å¤„ç†äººå­—æ®µ
ALTER TABLE violations 
ADD COLUMN processed_by VARCHAR(255) DEFAULT NULL 
COMMENT 'å¤„ç†äººï¼ˆç”¨æˆ·åæˆ–SYSTEMï¼‰';

-- å¤„ç†å¤‡æ³¨å­—æ®µ
ALTER TABLE violations 
ADD COLUMN process_remark TEXT DEFAULT NULL 
COMMENT 'å¤„ç†å¤‡æ³¨è¯´æ˜';

-- æ·»åŠ ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_process_status ON violations(process_status);
CREATE INDEX idx_process_type ON violations(process_type);
CREATE INDEX idx_plate_process ON violations(plate_number, process_status);
```

### 2.2 å­—æ®µè¯¦ç»†è¯´æ˜

| å­—æ®µå | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|--------|------|--------|------|--------|
| `process_status` | VARCHAR(20) | 'pending' | å¤„ç†çŠ¶æ€ | `pending` æˆ– `processed` |
| `process_type` | VARCHAR(50) | NULL | å¤„ç†æ–¹å¼ | `auto_blacklist` æˆ– `manual` |
| `processed_at` | TIMESTAMP | NULL | å¤„ç†æ—¶é—´ | `2025-01-31 15:30:00` |
| `processed_by` | VARCHAR(255) | NULL | å¤„ç†äºº | `SYSTEM` æˆ– `admin` |
| `process_remark` | TEXT | NULL | å¤„ç†å¤‡æ³¨ | `ç´¯è®¡è¿è§„3æ¬¡ï¼Œç³»ç»Ÿè‡ªåŠ¨æ‹‰é»‘` |

### 2.3 æ•°æ®çŠ¶æ€è½¬æ¢å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          åˆ›å»ºè¿è§„è®°å½•                            â”‚
â”‚  process_status = 'pending'                     â”‚
â”‚  process_type = NULL                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
        â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰‹åŠ¨å¤„ç†     â”‚       â”‚ è‡ªåŠ¨æ‹‰é»‘     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                       â”‚
        â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ processed    â”‚       â”‚ processed    â”‚
â”‚ manual       â”‚       â”‚ auto_blacklistâ”‚
â”‚ admin        â”‚       â”‚ SYSTEM       â”‚
â”‚ æ‰‹åŠ¨å¤„ç†å¤‡æ³¨  â”‚       â”‚ ç´¯è®¡3æ¬¡æ‹‰é»‘  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€åç«¯å®ç°æ–¹æ¡ˆ

### 3.1 å®ä½“ç±»ä¿®æ”¹

**æ–‡ä»¶è·¯å¾„**ï¼š`parking-demo/src/main/java/com/parkingmanage/entity/Violations.java`

åœ¨ `Violations` ç±»ä¸­æ·»åŠ æ–°å¢å­—æ®µï¼š

```java
package com.parkingmanage.entity;

import com.baomidou.mybatisplus.annotation.TableField;
import lombok.Data;
import java.time.LocalDateTime;

@Data
public class Violations {
    // ... åŸæœ‰å­—æ®µ ...
    
    /**
     * å¤„ç†çŠ¶æ€: pending-æœªå¤„ç†, processed-å·²å¤„ç†
     */
    @TableField("process_status")
    private String processStatus;
    
    /**
     * å¤„ç†æ–¹å¼: auto_blacklist-ç³»ç»Ÿè‡ªåŠ¨æ‹‰é»‘, manual-æ‰‹åŠ¨å¤„ç†
     */
    @TableField("process_type")
    private String processType;
    
    /**
     * å¤„ç†æ—¶é—´
     */
    @TableField("processed_at")
    private LocalDateTime processedAt;
    
    /**
     * å¤„ç†äººï¼ˆç”¨æˆ·åæˆ–SYSTEMï¼‰
     */
    @TableField("processed_by")
    private String processedBy;
    
    /**
     * å¤„ç†å¤‡æ³¨
     */
    @TableField("process_remark")
    private String processRemark;
}
```

### 3.2 Service å±‚æ¥å£å®šä¹‰

**æ–‡ä»¶è·¯å¾„**ï¼š`parking-demo/src/main/java/com/parkingmanage/service/ViolationsService.java`

æ·»åŠ æ–°çš„æ–¹æ³•å®šä¹‰ï¼š

```java
package com.parkingmanage.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import java.util.List;
import java.util.Map;

public interface ViolationsService {
    
    // ... åŸæœ‰æ–¹æ³• ...
    
    /**
     * ğŸ†• æ‰‹åŠ¨å¤„ç†å•æ¡è¿è§„è®°å½•
     * @param violationId è¿è§„è®°å½•ID
     * @param operatorName æ“ä½œå‘˜ç”¨æˆ·å
     * @param processRemark å¤„ç†å¤‡æ³¨
     * @return æ˜¯å¦å¤„ç†æˆåŠŸ
     */
    boolean manualProcessViolation(Long violationId, String operatorName, String processRemark);
    
    /**
     * ğŸ†• æ‰‹åŠ¨æ‰¹é‡å¤„ç†è¿è§„è®°å½•
     * @param violationIds è¿è§„è®°å½•IDåˆ—è¡¨
     * @param operatorName æ“ä½œå‘˜ç”¨æˆ·å
     * @param processRemark å¤„ç†å¤‡æ³¨
     * @return å¤„ç†æˆåŠŸçš„æ•°é‡
     */
    int batchProcessViolations(List<Long> violationIds, String operatorName, String processRemark);
    
    /**
     * ğŸ†• æ£€æŸ¥å¹¶æ‰§è¡Œè‡ªåŠ¨æ‹‰é»‘ï¼ˆåœ¨åˆ›å»ºè¿è§„è®°å½•æ—¶è°ƒç”¨ï¼‰
     * @param plateNumber è½¦ç‰Œå·
     * @param parkCode åœè½¦åœºç¼–ç 
     * @return æ˜¯å¦è§¦å‘äº†è‡ªåŠ¨æ‹‰é»‘
     */
    boolean checkAndAutoBlacklist(String plateNumber, String parkCode);
    
    /**
     * ğŸ†• ç»Ÿè®¡æŒ‡å®šè½¦ç‰Œçš„æœªå¤„ç†è¿è§„æ¬¡æ•°
     * @param plateNumber è½¦ç‰Œå·
     * @return æœªå¤„ç†è¿è§„æ¬¡æ•°
     */
    int countUnprocessedViolations(String plateNumber);
    
    /**
     * ğŸ†• ä¿®æ”¹åˆ†é¡µæŸ¥è¯¢æ¥å£ï¼Œæ”¯æŒå¤„ç†çŠ¶æ€å’Œå¤„ç†æ–¹å¼ç­›é€‰
     */
    IPage<Map<String, Object>> getViolationsWithOwnerInfo(
            Page<Map<String, Object>> pageParam,
            String plateNumber,
            String status,
            String violationType,
            LocalDateTime startDate,
            LocalDateTime endDate,
            String createdByFilter,
            String communityFilter,
            String processStatus,      // ğŸ†• å¤„ç†çŠ¶æ€ç­›é€‰
            String processType,        // ğŸ†• å¤„ç†æ–¹å¼ç­›é€‰
            Boolean onlyUnprocessed    // ğŸ†• æ˜¯å¦ä»…æŸ¥è¯¢æœªå¤„ç†
    );
}
```

### 3.3 Service å±‚å®ç°

**æ–‡ä»¶è·¯å¾„**ï¼š`parking-demo/src/main/java/com/parkingmanage/service/impl/ViolationsServiceImpl.java`

```java
package com.parkingmanage.service.impl;

import com.parkingmanage.service.ViolationsService;
import com.parkingmanage.service.BlacklistService;
import com.parkingmanage.mapper.ViolationsMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.annotation.Resource;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;

@Slf4j
@Service
public class ViolationsServiceImpl implements ViolationsService {
    
    @Resource
    private ViolationsMapper violationsMapper;
    
    @Resource
    private BlacklistService blacklistService;
    
    @Resource
    private MonthlyTicketTimeoutConfigService configService;
    
    /**
     * ğŸ†• æ‰‹åŠ¨å¤„ç†å•æ¡è¿è§„è®°å½•
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean manualProcessViolation(Long violationId, String operatorName, String processRemark) {
        log.info("ğŸ‘¨â€ğŸ’¼ [æ‰‹åŠ¨å¤„ç†] å¼€å§‹å¤„ç†è¿è§„è®°å½• - ID: {}, æ“ä½œå‘˜: {}", violationId, operatorName);
        
        try {
            // 1. æŸ¥è¯¢è¿è§„è®°å½•
            Violations violation = violationsMapper.selectById(violationId);
            if (violation == null) {
                log.warn("âš ï¸ [æ‰‹åŠ¨å¤„ç†] è¿è§„è®°å½•ä¸å­˜åœ¨ - ID: {}", violationId);
                return false;
            }
            
            // 2. æ£€æŸ¥æ˜¯å¦å·²å¤„ç†
            if ("processed".equals(violation.getProcessStatus())) {
                log.warn("âš ï¸ [æ‰‹åŠ¨å¤„ç†] è¿è§„è®°å½•å·²è¢«å¤„ç† - ID: {}, å¤„ç†æ–¹å¼: {}", 
                        violationId, violation.getProcessType());
                return false;
            }
            
            // 3. æ›´æ–°å¤„ç†çŠ¶æ€
            violation.setProcessStatus("processed");
            violation.setProcessType("manual");
            violation.setProcessedAt(LocalDateTime.now());
            violation.setProcessedBy(operatorName);
            violation.setProcessRemark(processRemark != null && !processRemark.trim().isEmpty() 
                    ? processRemark : "æ‰‹åŠ¨å¤„ç†");
            
            int updated = violationsMapper.updateById(violation);
            
            if (updated > 0) {
                log.info("âœ… [æ‰‹åŠ¨å¤„ç†] å¤„ç†æˆåŠŸ - ID: {}, è½¦ç‰Œ: {}", violationId, violation.getPlateNumber());
                return true;
            }
            
            return false;
            
        } catch (Exception e) {
            log.error("âŒ [æ‰‹åŠ¨å¤„ç†] å¤„ç†å¤±è´¥ - ID: {}, é”™è¯¯: {}", violationId, e.getMessage(), e);
            throw e;
        }
    }
    
    /**
     * ğŸ†• æ‰‹åŠ¨æ‰¹é‡å¤„ç†è¿è§„è®°å½•
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public int batchProcessViolations(List<Long> violationIds, String operatorName, String processRemark) {
        log.info("ğŸ“‹ [æ‰¹é‡å¤„ç†] å¼€å§‹æ‰¹é‡å¤„ç† - æ•°é‡: {}, æ“ä½œå‘˜: {}", violationIds.size(), operatorName);
        
        int successCount = 0;
        int failCount = 0;
        
        for (Long violationId : violationIds) {
            try {
                boolean success = manualProcessViolation(violationId, operatorName, processRemark);
                if (success) {
                    successCount++;
                } else {
                    failCount++;
                }
            } catch (Exception e) {
                log.error("âŒ [æ‰¹é‡å¤„ç†] å¤„ç†å•æ¡è®°å½•å¤±è´¥ - ID: {}, é”™è¯¯: {}", violationId, e.getMessage());
                failCount++;
            }
        }
        
        log.info("âœ… [æ‰¹é‡å¤„ç†] å¤„ç†å®Œæˆ - æˆåŠŸ: {}, å¤±è´¥: {}", successCount, failCount);
        return successCount;
    }
    
    /**
     * ğŸ†• æ£€æŸ¥å¹¶æ‰§è¡Œè‡ªåŠ¨æ‹‰é»‘
     * æ ¸å¿ƒé€»è¾‘ï¼šç¬¬Næ¬¡è¿è§„æ—¶è§¦å‘è‡ªåŠ¨æ‹‰é»‘
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean checkAndAutoBlacklist(String plateNumber, String parkCode) {
        log.info("ğŸ” [è‡ªåŠ¨æ‹‰é»‘æ£€æŸ¥] å¼€å§‹æ£€æŸ¥ - è½¦ç‰Œ: {}, åœè½¦åœº: {}", plateNumber, parkCode);
        
        try {
            // 1. ç»Ÿè®¡è¯¥è½¦ç‰Œçš„æœªå¤„ç†è¿è§„æ¬¡æ•°ï¼ˆåŒ…æ‹¬åˆšåˆ›å»ºçš„è¿™æ¡ï¼‰
            int unprocessedCount = countUnprocessedViolations(plateNumber);
            log.info("ğŸ“Š [è¿è§„ç»Ÿè®¡] è½¦ç‰Œ {} å½“å‰æœªå¤„ç†è¿è§„æ¬¡æ•°: {}", plateNumber, unprocessedCount);
            
            // 2. è·å–é…ç½®çš„è¿è§„æ¬¡æ•°é˜ˆå€¼
            Map<String, Object> config = getMonthlyTicketTimeoutConfig(parkCode);
            Integer maxViolationCount = (Integer) config.get("maxViolationCount");
            
            if (maxViolationCount == null) {
                maxViolationCount = 3; // é»˜è®¤3æ¬¡
                log.warn("âš ï¸ [é…ç½®ç¼ºå¤±] æœªæ‰¾åˆ°è¿è§„æ¬¡æ•°é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼: {}", maxViolationCount);
            }
            
            log.info("âš™ï¸ [é…ç½®ä¿¡æ¯] åœè½¦åœº {} é…ç½®çš„è¿è§„æ¬¡æ•°é˜ˆå€¼: {}", parkCode, maxViolationCount);
            
            // 3. åˆ¤æ–­æ˜¯å¦è¾¾åˆ°æ‹‰é»‘æ¡ä»¶
            if (unprocessedCount >= maxViolationCount) {
                log.warn("ğŸš« [è§¦å‘æ‹‰é»‘] è½¦ç‰Œ {} è¿è§„æ¬¡æ•° {} å·²è¾¾åˆ°é˜ˆå€¼ {}ï¼Œå¼€å§‹æ‰§è¡Œè‡ªåŠ¨æ‹‰é»‘", 
                        plateNumber, unprocessedCount, maxViolationCount);
                
                // 4. æ‰§è¡Œæ‹‰é»‘æ“ä½œ
                boolean blacklisted = executeAutoBlacklist(plateNumber, unprocessedCount);
                
                if (blacklisted) {
                    log.info("âœ… [è‡ªåŠ¨æ‹‰é»‘] è½¦ç‰Œ {} å·²æˆåŠŸåŠ å…¥é»‘åå•", plateNumber);
                    return true;
                } else {
                    log.error("âŒ [è‡ªåŠ¨æ‹‰é»‘] è½¦ç‰Œ {} åŠ å…¥é»‘åå•å¤±è´¥", plateNumber);
                    return false;
                }
            } else {
                log.info("â„¹ï¸ [æœªè¾¾é˜ˆå€¼] è½¦ç‰Œ {} è¿è§„æ¬¡æ•° {} æœªè¾¾åˆ°é˜ˆå€¼ {}ï¼Œæš‚ä¸æ‹‰é»‘", 
                        plateNumber, unprocessedCount, maxViolationCount);
                return false;
            }
            
        } catch (Exception e) {
            log.error("âŒ [è‡ªåŠ¨æ‹‰é»‘æ£€æŸ¥] æ£€æŸ¥å¤±è´¥ - è½¦ç‰Œ: {}, é”™è¯¯: {}", plateNumber, e.getMessage(), e);
            throw e;
        }
    }
    
    /**
     * ğŸ”§ æ‰§è¡Œè‡ªåŠ¨æ‹‰é»‘æ“ä½œï¼ˆå†…éƒ¨æ–¹æ³•ï¼‰
     */
    private boolean executeAutoBlacklist(String plateNumber, int violationCount) {
        try {
            // 1. æ·»åŠ åˆ°é»‘åå•è¡¨
            String blacklistReason = String.format("ç´¯è®¡è¿è§„%dæ¬¡ï¼Œç³»ç»Ÿè‡ªåŠ¨æ‹‰é»‘", violationCount);
            boolean addedToBlacklist = blacklistService.addToBlacklist(
                    plateNumber, 
                    blacklistReason, 
                    "SYSTEM"
            );
            
            if (!addedToBlacklist) {
                log.error("âŒ [è‡ªåŠ¨æ‹‰é»‘] æ·»åŠ åˆ°é»‘åå•å¤±è´¥ - è½¦ç‰Œ: {}", plateNumber);
                return false;
            }
            
            log.info("âœ… [é»‘åå•æ·»åŠ ] è½¦ç‰Œ {} å·²æ·»åŠ åˆ°é»‘åå•", plateNumber);
            
            // 2. æ‰¹é‡æ ‡è®°è¯¥è½¦ç‰Œçš„æ‰€æœ‰æœªå¤„ç†è¿è§„è®°å½•ä¸ºå·²å¤„ç†
            int processedCount = violationsMapper.batchUpdateProcessStatusByPlate(
                    plateNumber,
                    "processed",
                    "auto_blacklist",
                    LocalDateTime.now(),
                    "SYSTEM",
                    blacklistReason
            );
            
            log.info("âœ… [æ‰¹é‡æ ‡è®°] è½¦ç‰Œ {} çš„ {} æ¡è¿è§„è®°å½•å·²æ ‡è®°ä¸ºå·²å¤„ç†", plateNumber, processedCount);
            
            return true;
            
        } catch (Exception e) {
            log.error("âŒ [è‡ªåŠ¨æ‹‰é»‘] æ‰§è¡Œå¤±è´¥ - è½¦ç‰Œ: {}, é”™è¯¯: {}", plateNumber, e.getMessage(), e);
            throw e;
        }
    }
    
    /**
     * ğŸ†• ç»Ÿè®¡æŒ‡å®šè½¦ç‰Œçš„æœªå¤„ç†è¿è§„æ¬¡æ•°
     */
    @Override
    public int countUnprocessedViolations(String plateNumber) {
        return violationsMapper.countUnprocessedByPlate(plateNumber);
    }
    
    /**
     * ğŸ”§ ä¿®æ”¹åŸæœ‰çš„åˆ›å»ºè¿è§„è®°å½•æ–¹æ³•ï¼Œé›†æˆè‡ªåŠ¨æ‹‰é»‘æ£€æŸ¥
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean createViolation(Violations violation) {
        log.info("ğŸ†• [åˆ›å»ºè¿è§„è®°å½•] å¼€å§‹åˆ›å»º - è½¦ç‰Œ: {}", violation.getPlateNumber());
        
        try {
            // 1. è®¾ç½®åˆå§‹çŠ¶æ€ä¸ºæœªå¤„ç†
            violation.setProcessStatus("pending");
            
            // 2. ä¿å­˜è¿è§„è®°å½•
            boolean saved = save(violation);
            
            if (!saved) {
                log.error("âŒ [åˆ›å»ºè¿è§„è®°å½•] ä¿å­˜å¤±è´¥ - è½¦ç‰Œ: {}", violation.getPlateNumber());
                return false;
            }
            
            log.info("âœ… [åˆ›å»ºè¿è§„è®°å½•] ä¿å­˜æˆåŠŸ - ID: {}, è½¦ç‰Œ: {}", 
                    violation.getId(), violation.getPlateNumber());
            
            // 3. æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨æ‹‰é»‘
            checkAndAutoBlacklist(violation.getPlateNumber(), violation.getParkCode());
            
            return true;
            
        } catch (Exception e) {
            log.error("âŒ [åˆ›å»ºè¿è§„è®°å½•] åˆ›å»ºå¤±è´¥ - è½¦ç‰Œ: {}, é”™è¯¯: {}", 
                    violation.getPlateNumber(), e.getMessage(), e);
            throw e;
        }
    }
    
    /**
     * ğŸ”§ ä¿®æ”¹åˆ†é¡µæŸ¥è¯¢æ–¹æ³•ï¼Œæ”¯æŒæ–°çš„ç­›é€‰æ¡ä»¶
     */
    @Override
    public IPage<Map<String, Object>> getViolationsWithOwnerInfo(
            Page<Map<String, Object>> pageParam,
            String plateNumber,
            String status,
            String violationType,
            LocalDateTime startDate,
            LocalDateTime endDate,
            String createdByFilter,
            String communityFilter,
            String processStatus,      // ğŸ†• å¤„ç†çŠ¶æ€ç­›é€‰
            String processType,        // ğŸ†• å¤„ç†æ–¹å¼ç­›é€‰
            Boolean onlyUnprocessed    // ğŸ†• æ˜¯å¦ä»…æŸ¥è¯¢æœªå¤„ç†
    ) {
        return violationsMapper.getViolationsWithOwnerInfo(
                pageParam, plateNumber, status, violationType, 
                startDate, endDate, createdByFilter, communityFilter,
                processStatus, processType, onlyUnprocessed
        );
    }
}
```

### 3.4 Mapper å±‚ä¿®æ”¹

**æ–‡ä»¶è·¯å¾„**ï¼š`parking-demo/src/main/java/com/parkingmanage/mapper/ViolationsMapper.java`

æ·»åŠ æ–°çš„æ–¹æ³•å®šä¹‰ï¼š

```java
package com.parkingmanage.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.parkingmanage.entity.Violations;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.time.LocalDateTime;
import java.util.Map;

@Mapper
public interface ViolationsMapper extends BaseMapper<Violations> {
    
    /**
     * ğŸ†• ç»Ÿè®¡æŒ‡å®šè½¦ç‰Œçš„æœªå¤„ç†è¿è§„æ¬¡æ•°
     */
    int countUnprocessedByPlate(@Param("plateNumber") String plateNumber);
    
    /**
     * ğŸ†• æ‰¹é‡æ›´æ–°æŒ‡å®šè½¦ç‰Œçš„è¿è§„è®°å½•å¤„ç†çŠ¶æ€
     */
    int batchUpdateProcessStatusByPlate(
            @Param("plateNumber") String plateNumber,
            @Param("processStatus") String processStatus,
            @Param("processType") String processType,
            @Param("processedAt") LocalDateTime processedAt,
            @Param("processedBy") String processedBy,
            @Param("processRemark") String processRemark
    );
    
    /**
     * ğŸ”§ ä¿®æ”¹åˆ†é¡µæŸ¥è¯¢æ–¹æ³•ï¼ˆæ”¯æŒå¤„ç†çŠ¶æ€ç­›é€‰ï¼‰
     */
    IPage<Map<String, Object>> getViolationsWithOwnerInfo(
            Page<Map<String, Object>> page,
            @Param("plateNumber") String plateNumber,
            @Param("status") String status,
            @Param("violationType") String violationType,
            @Param("startDate") LocalDateTime startDate,
            @Param("endDate") LocalDateTime endDate,
            @Param("createdBy") String createdBy,
            @Param("community") String community,
            @Param("processStatus") String processStatus,      // ğŸ†•
            @Param("processType") String processType,          // ğŸ†•
            @Param("onlyUnprocessed") Boolean onlyUnprocessed  // ğŸ†•
    );
}
```

**æ–‡ä»¶è·¯å¾„**ï¼š`parking-demo/src/main/resources/mapper/ViolationsMapper.xml`

æ·»åŠ æ–°çš„SQLæ˜ å°„ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.parkingmanage.mapper.ViolationsMapper">
    
    <!-- ğŸ†• ç»Ÿè®¡æŒ‡å®šè½¦ç‰Œçš„æœªå¤„ç†è¿è§„æ¬¡æ•° -->
    <select id="countUnprocessedByPlate" resultType="int">
        SELECT COUNT(*)
        FROM violations
        WHERE plate_number = #{plateNumber}
          AND (process_status IS NULL OR process_status = 'pending')
    </select>
    
    <!-- ğŸ†• æ‰¹é‡æ›´æ–°æŒ‡å®šè½¦ç‰Œçš„è¿è§„è®°å½•å¤„ç†çŠ¶æ€ -->
    <update id="batchUpdateProcessStatusByPlate">
        UPDATE violations
        SET process_status = #{processStatus},
            process_type = #{processType},
            processed_at = #{processedAt},
            processed_by = #{processedBy},
            process_remark = #{processRemark},
            updated_at = NOW()
        WHERE plate_number = #{plateNumber}
          AND (process_status IS NULL OR process_status = 'pending')
    </update>
    
    <!-- ğŸ”§ ä¿®æ”¹åˆ†é¡µæŸ¥è¯¢SQLï¼Œæ”¯æŒæ–°çš„ç­›é€‰æ¡ä»¶ -->
    <select id="getViolationsWithOwnerInfo" resultType="java.util.Map">
        SELECT 
            v.id,
            v.plate_number AS plateNumber,
            v.violation_type AS violationType,
            v.location,
            v.description,
            v.photos,
            v.created_at AS createdAt,
            v.created_by AS createdBy,
            v.park_name AS parkName,
            v.owner_name AS ownerName,
            v.owner_phone AS ownerPhone,
            v.owner_address AS ownerAddress,
            v.process_status AS processStatus,
            v.process_type AS processType,
            v.processed_at AS processedAt,
            v.processed_by AS processedBy,
            v.process_remark AS processRemark
        FROM violations v
        <where>
            <!-- åŸæœ‰æŸ¥è¯¢æ¡ä»¶ -->
            <if test="plateNumber != null and plateNumber != ''">
                AND v.plate_number LIKE CONCAT('%', #{plateNumber}, '%')
            </if>
            <if test="violationType != null and violationType != ''">
                AND v.violation_type = #{violationType}
            </if>
            <if test="startDate != null">
                AND v.created_at &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND v.created_at &lt;= #{endDate}
            </if>
            <if test="createdBy != null and createdBy != ''">
                AND v.created_by = #{createdBy}
            </if>
            <if test="community != null and community != ''">
                AND v.park_name = #{community}
            </if>
            
            <!-- ğŸ†• å¤„ç†çŠ¶æ€ç­›é€‰ -->
            <if test="processStatus != null and processStatus != ''">
                AND v.process_status = #{processStatus}
            </if>
            
            <!-- ğŸ†• å¤„ç†æ–¹å¼ç­›é€‰ -->
            <if test="processType != null and processType != ''">
                AND v.process_type = #{processType}
            </if>
            
            <!-- ğŸ†• ä»…æŸ¥è¯¢æœªå¤„ç†çš„è®°å½•ï¼ˆå°ç¨‹åºç«¯ä½¿ç”¨ï¼‰ -->
            <if test="onlyUnprocessed != null and onlyUnprocessed == true">
                AND (v.process_status IS NULL OR v.process_status = 'pending')
            </if>
        </where>
        ORDER BY v.created_at DESC
    </select>
    
</mapper>
```

### 3.5 Controller å±‚ä¿®æ”¹

**æ–‡ä»¶è·¯å¾„**ï¼š`parking-demo/src/main/java/com/parkingmanage/controller/ViolationsController.java`

æ·»åŠ æ–°çš„æ¥å£æ–¹æ³•ï¼š

```java
package com.parkingmanage.controller;

import com.parkingmanage.common.Result;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;
import java.util.List;
import java.util.Map;

@Slf4j
@RestController
@RequestMapping("/parking/violations")
@Api(tags = "è¿è§„è®°å½•ç®¡ç†")
public class ViolationsController {
    
    @Resource
    private ViolationsService violationsService;
    
    /**
     * ğŸ†• æ‰‹åŠ¨å¤„ç†å•æ¡è¿è§„è®°å½•
     */
    @PostMapping("/{id}/process")
    @ApiOperation("æ‰‹åŠ¨å¤„ç†è¿è§„è®°å½•")
    public Result<Boolean> processViolation(
            @ApiParam("è¿è§„è®°å½•ID") @PathVariable Long id,
            @ApiParam("å¤„ç†å¤‡æ³¨") @RequestParam(required = false) String processRemark,
            HttpServletRequest request) {
        
        log.info("ğŸ‘¨â€ğŸ’¼ [æ‰‹åŠ¨å¤„ç†æ¥å£] æ¥æ”¶åˆ°å¤„ç†è¯·æ±‚ - ID: {}, å¤‡æ³¨: {}", id, processRemark);
        
        try {
            // è·å–å½“å‰æ“ä½œå‘˜ä¿¡æ¯
            String operatorName = getCurrentUserId(request);
            
            if ("anonymous".equals(operatorName)) {
                log.warn("âš ï¸ [æ‰‹åŠ¨å¤„ç†æ¥å£] æ— æ³•è·å–æ“ä½œå‘˜ä¿¡æ¯");
                return Result.error("æ— æ³•è·å–æ“ä½œå‘˜ä¿¡æ¯");
            }
            
            // è°ƒç”¨Serviceå±‚å¤„ç†
            boolean result = violationsService.manualProcessViolation(id, operatorName, processRemark);
            
            if (result) {
                log.info("âœ… [æ‰‹åŠ¨å¤„ç†æ¥å£] å¤„ç†æˆåŠŸ - ID: {}", id);
                return Result.success(true);
            } else {
                log.warn("âš ï¸ [æ‰‹åŠ¨å¤„ç†æ¥å£] å¤„ç†å¤±è´¥ - ID: {}", id);
                return Result.error("å¤„ç†å¤±è´¥ï¼Œè®°å½•å¯èƒ½ä¸å­˜åœ¨æˆ–å·²è¢«å¤„ç†");
            }
            
        } catch (Exception e) {
            log.error("âŒ [æ‰‹åŠ¨å¤„ç†æ¥å£] å¤„ç†å¼‚å¸¸ - ID: {}, é”™è¯¯: {}", id, e.getMessage(), e);
            return Result.error("å¤„ç†å¤±è´¥ï¼š" + e.getMessage());
        }
    }
    
    /**
     * ğŸ†• æ‰‹åŠ¨æ‰¹é‡å¤„ç†è¿è§„è®°å½•
     */
    @PostMapping("/batch-process")
    @ApiOperation("æ‰¹é‡å¤„ç†è¿è§„è®°å½•")
    public Result<Map<String, Object>> batchProcessViolations(
            @ApiParam("è¿è§„è®°å½•IDåˆ—è¡¨") @RequestBody Map<String, Object> requestBody,
            HttpServletRequest request) {
        
        log.info("ğŸ“‹ [æ‰¹é‡å¤„ç†æ¥å£] æ¥æ”¶åˆ°æ‰¹é‡å¤„ç†è¯·æ±‚");
        
        try {
            // è·å–æ“ä½œå‘˜ä¿¡æ¯
            String operatorName = getCurrentUserId(request);
            
            if ("anonymous".equals(operatorName)) {
                return Result.error("æ— æ³•è·å–æ“ä½œå‘˜ä¿¡æ¯");
            }
            
            // è§£æå‚æ•°
            @SuppressWarnings("unchecked")
            List<Long> violationIds = (List<Long>) requestBody.get("violationIds");
            String processRemark = (String) requestBody.get("processRemark");
            
            if (violationIds == null || violationIds.isEmpty()) {
                return Result.error("è¿è§„è®°å½•IDåˆ—è¡¨ä¸èƒ½ä¸ºç©º");
            }
            
            log.info("ğŸ“‹ [æ‰¹é‡å¤„ç†æ¥å£] å¾…å¤„ç†æ•°é‡: {}, æ“ä½œå‘˜: {}", violationIds.size(), operatorName);
            
            // è°ƒç”¨Serviceå±‚æ‰¹é‡å¤„ç†
            int successCount = violationsService.batchProcessViolations(
                    violationIds, operatorName, processRemark);
            
            // æ„å»ºå“åº”ç»“æœ
            Map<String, Object> result = new java.util.HashMap<>();
            result.put("total", violationIds.size());
            result.put("success", successCount);
            result.put("failed", violationIds.size() - successCount);
            
            log.info("âœ… [æ‰¹é‡å¤„ç†æ¥å£] æ‰¹é‡å¤„ç†å®Œæˆ - æ€»æ•°: {}, æˆåŠŸ: {}, å¤±è´¥: {}", 
                    violationIds.size(), successCount, violationIds.size() - successCount);
            
            return Result.success(result);
            
        } catch (Exception e) {
            log.error("âŒ [æ‰¹é‡å¤„ç†æ¥å£] æ‰¹é‡å¤„ç†å¼‚å¸¸ - é”™è¯¯: {}", e.getMessage(), e);
            return Result.error("æ‰¹é‡å¤„ç†å¤±è´¥ï¼š" + e.getMessage());
        }
    }
    
    /**
     * ğŸ”§ ä¿®æ”¹åˆ†é¡µæŸ¥è¯¢æ¥å£ï¼Œæ”¯æŒæ–°çš„ç­›é€‰æ¡ä»¶
     */
    @GetMapping
    @ApiOperation("åˆ†é¡µæŸ¥è¯¢è¿è§„è®°å½•")
    public Result<IPage<Map<String, Object>>> getViolations(
            @ApiParam("é¡µç ") @RequestParam(defaultValue = "1") Integer page,
            @ApiParam("é¡µå¤§å°") @RequestParam(defaultValue = "20") Integer size,
            @ApiParam("è½¦ç‰Œå·") @RequestParam(required = false) String plateNumber,
            @ApiParam("è¿è§„ç±»å‹") @RequestParam(required = false) String violationType,
            @ApiParam("å¼€å§‹æ—¶é—´") @RequestParam(required = false) String startDate,
            @ApiParam("ç»“æŸæ—¶é—´") @RequestParam(required = false) String endDate,
            @ApiParam("ç”¨æˆ·è§’è‰²") @RequestParam(required = false) String userRole,
            @ApiParam("å°åŒºåç§°") @RequestParam(required = false) String park_name,
            @ApiParam("å¤„ç†çŠ¶æ€") @RequestParam(required = false) String processStatus,      // ğŸ†•
            @ApiParam("å¤„ç†æ–¹å¼") @RequestParam(required = false) String processType,        // ğŸ†•
            @ApiParam("æ˜¯å¦ä»…æŸ¥è¯¢æœªå¤„ç†") @RequestParam(required = false) Boolean onlyUnprocessed, // ğŸ†•
            HttpServletRequest request) {
        
        log.info("ğŸ” [æŸ¥è¯¢æ¥å£] æ¥æ”¶åˆ°æŸ¥è¯¢è¯·æ±‚ - å¤„ç†çŠ¶æ€: {}, å¤„ç†æ–¹å¼: {}, ä»…æœªå¤„ç†: {}", 
                processStatus, processType, onlyUnprocessed);
        
        // ... åŸæœ‰çš„å‚æ•°è§£æå’Œæƒé™æ£€æŸ¥é€»è¾‘ ...
        
        Page<Map<String, Object>> pageParam = new Page<>(page, size);
        IPage<Map<String, Object>> result = violationsService.getViolationsWithOwnerInfo(
                pageParam, plateNumber, null, violationType, 
                parsedStartDate, parsedEndDate, 
                createdByFilter, communityFilter,
                processStatus, processType, onlyUnprocessed  // ğŸ†• ä¼ é€’æ–°å‚æ•°
        );
        
        return Result.success(result);
    }
}
```

---

## å››ã€å‰ç«¯å®ç°æ–¹æ¡ˆ

### 4.1 åå°ç®¡ç†é¡µé¢ä¿®æ”¹

**æ–‡ä»¶è·¯å¾„**ï¼š`manage-front/src/views/admin/IllegalRegiste.vue`

#### 4.1.1 æ•°æ®æ¨¡å‹ä¿®æ”¹

```javascript
<script setup>
// ... å…¶ä»–å¯¼å…¥ ...

// æŸ¥è¯¢æ¡ä»¶
const query = reactive({
    plateNumber: "",
    ownerName: "",
    ownerPhone: "",
    location: "",
    violationType: "",
    dateRange: [],
    processStatus: "",      // ğŸ†• å¤„ç†çŠ¶æ€ç­›é€‰
    processType: "",        // ğŸ†• å¤„ç†æ–¹å¼ç­›é€‰
    pageNum: 1,
    pageSize: 10,
});

// ğŸ†• æ‰¹é‡å¤„ç†ç›¸å…³å˜é‡
const multipleSelection = ref([]);           // é€‰ä¸­çš„è®°å½•
const showBatchProcessDialog = ref(false);   // æ‰¹é‡å¤„ç†å¼¹çª—
const batchProcessRemark = ref("");          // æ‰¹é‡å¤„ç†å¤‡æ³¨

// ğŸ†• å•æ¡å¤„ç†ç›¸å…³å˜é‡
const processShow = ref(false);              // å¤„ç†å¼¹çª—
const processForm = ref({
    id: null,
    plateNumber: "",
    violationType: "",
    processRemark: ""
});
</script>
```

#### 4.1.2 æœç´¢é¢æ¿ä¿®æ”¹

åœ¨æœç´¢é¢æ¿ä¸­æ·»åŠ å¤„ç†çŠ¶æ€å’Œå¤„ç†æ–¹å¼ç­›é€‰ï¼š

```vue
<template>
    <!-- æœç´¢é¢æ¿ -->
    <div class="search-panel">
        <div class="search-panel-body">
            <el-form :inline="true" :model="query" class="search-form">
                <!-- åŸæœ‰æœç´¢æ¡ä»¶ -->
                <!-- ... -->
                
                <!-- ğŸ†• å¤„ç†çŠ¶æ€ç­›é€‰ -->
                <div class="search-row">
                    <el-form-item label="å¤„ç†çŠ¶æ€" class="search-item">
                        <el-select v-model="query.processStatus" placeholder="è¯·é€‰æ‹©å¤„ç†çŠ¶æ€" clearable>
                            <el-option label="å…¨éƒ¨" value=""></el-option>
                            <el-option label="æœªå¤„ç†" value="pending"></el-option>
                            <el-option label="å·²å¤„ç†" value="processed"></el-option>
                        </el-select>
                    </el-form-item>
                    
                    <!-- ğŸ†• å¤„ç†æ–¹å¼ç­›é€‰ -->
                    <el-form-item label="å¤„ç†æ–¹å¼" class="search-item">
                        <el-select v-model="query.processType" placeholder="è¯·é€‰æ‹©å¤„ç†æ–¹å¼" clearable>
                            <el-option label="å…¨éƒ¨" value=""></el-option>
                            <el-option label="ç³»ç»Ÿè‡ªåŠ¨æ‹‰é»‘" value="auto_blacklist"></el-option>
                            <el-option label="æ‰‹åŠ¨å¤„ç†" value="manual"></el-option>
                        </el-select>
                    </el-form-item>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="search-actions">
                    <div class="search-buttons">
                        <el-button type="warning" icon="RefreshRight" @click="handleReset" size="small">
                            é‡ç½®
                        </el-button>
                        <el-button type="primary" icon="Search" @click="handleSearch" size="small">
                            æœç´¢
                        </el-button>
                    </div>
                    
                    <div class="action-buttons">
                        <!-- ğŸ†• æ‰¹é‡å¤„ç†æŒ‰é’® -->
                        <el-button 
                            type="primary" 
                            icon="Check" 
                            @click="handleBatchProcess" 
                            size="small"
                            :disabled="multipleSelection.length === 0">
                            æ‰¹é‡å¤„ç† ({{ multipleSelection.length }})
                        </el-button>
                        <el-button type="success" icon="Download" @click="handleExport" size="small">
                            å¯¼å‡ºæ•°æ®
                        </el-button>
                    </div>
                </div>
            </el-form>
        </div>
    </div>
</template>
```

#### 4.1.3 è¡¨æ ¼åˆ—ä¿®æ”¹

```vue
<template>
    <!-- è¿è§„è®°å½•åˆ—è¡¨ -->
    <div class="table-panel-body">
        <el-table 
            :data="tableData" 
            class="modern-table" 
            ref="multipleTable"
            @selection-change="handleSelectionChange"
            height="430" 
            stripe>
            
            <!-- ğŸ†• å¤é€‰æ¡†åˆ—ï¼ˆç”¨äºæ‰¹é‡å¤„ç†ï¼‰ -->
            <el-table-column type="selection" width="55" align="center" fixed="left"></el-table-column>
            
            <!-- åŸæœ‰åˆ—... -->
            
            <!-- ğŸ†• å¤„ç†çŠ¶æ€åˆ— -->
            <el-table-column label="å¤„ç†çŠ¶æ€" width="200" align="center">
                <template #default="{ row }">
                    <div class="process-status-cell">
                        <!-- å¤„ç†çŠ¶æ€æ ‡ç­¾ -->
                        <el-tag 
                            :type="row.processStatus === 'processed' ? 'success' : 'warning'" 
                            size="small"
                            effect="dark">
                            {{ row.processStatus === 'processed' ? 'âœ… å·²å¤„ç†' : 'â³ æœªå¤„ç†' }}
                        </el-tag>
                        
                        <!-- å¤„ç†æ–¹å¼æ ‡ç­¾ -->
                        <div v-if="row.processStatus === 'processed'" class="process-type-tag">
                            <el-tag 
                                :type="row.processType === 'auto_blacklist' ? 'danger' : 'info'" 
                                size="small"
                                style="margin-top: 6px;">
                                {{ row.processType === 'auto_blacklist' ? 'ğŸ¤– ç³»ç»Ÿè‡ªåŠ¨æ‹‰é»‘' : 'ğŸ‘¨â€ğŸ’¼ æ‰‹åŠ¨å¤„ç†' }}
                            </el-tag>
                        </div>
                        
                        <!-- å¤„ç†ä¿¡æ¯ -->
                        <div v-if="row.processStatus === 'processed'" class="process-info">
                            <div class="process-detail">
                                <span class="process-label">å¤„ç†äººï¼š</span>
                                <span class="process-value">{{ row.processedBy || '-' }}</span>
                            </div>
                            <div class="process-detail">
                                <span class="process-label">å¤„ç†æ—¶é—´ï¼š</span>
                                <span class="process-value">{{ formatTimestamp(row.processedAt) }}</span>
                            </div>
                            <div v-if="row.processRemark" class="process-detail">
                                <span class="process-label">å¤‡æ³¨ï¼š</span>
                                <span class="process-value remark-text">{{ row.processRemark }}</span>
                            </div>
                        </div>
                    </div>
                </template>
            </el-table-column>
            
            <!-- æ“ä½œåˆ— -->
            <el-table-column label="æ“ä½œ" width="280" align="center" fixed="right">
                <template #default="{ row }">
                    <div class="action-buttons-inline">
                        <el-button type="info" text icon="View" @click="handleView(row)">
                            è¯¦æƒ…
                        </el-button>
                        
                        <!-- ğŸ†• æ‰‹åŠ¨å¤„ç†æŒ‰é’®ï¼ˆä»…æœªå¤„ç†çš„è®°å½•æ˜¾ç¤ºï¼‰ -->
                        <el-button 
                            v-if="row.processStatus !== 'processed'"
                            type="success" 
                            text 
                            icon="Check"
                            @click="handleProcess(row)">
                            å¤„ç†
                        </el-button>
                        
                        <!-- å·²å¤„ç†æ ‡è¯† -->
                        <el-tag 
                            v-else
                            type="success" 
                            size="small"
                            effect="plain">
                            å·²å¤„ç†
                        </el-tag>
                    </div>
                </template>
            </el-table-column>
        </el-table>
    </div>
</template>
```

#### 4.1.4 å¤„ç†å¼¹çª—

```vue
<template>
    <!-- ğŸ†• å•æ¡å¤„ç†å¼¹çª— -->
    <el-dialog title="å¤„ç†è¿è§„è®°å½•" v-model="processShow" width="500px" class="process-dialog">
        <el-form :model="processForm" label-width="100px">
            <el-form-item label="è½¦ç‰Œå·">
                <el-input v-model="processForm.plateNumber" disabled></el-input>
            </el-form-item>
            
            <el-form-item label="è¿è§„ç±»å‹">
                <el-input v-model="processForm.violationType" disabled></el-input>
            </el-form-item>
            
            <el-form-item label="å¤„ç†å¤‡æ³¨">
                <el-input 
                    type="textarea" 
                    v-model="processForm.processRemark" 
                    placeholder="è¯·è¾“å…¥å¤„ç†è¯´æ˜ï¼ˆå¯é€‰ï¼‰..."
                    :rows="4"
                    maxlength="200"
                    show-word-limit>
                </el-input>
            </el-form-item>
        </el-form>
        
        <template #footer>
            <div class="dialog-footer">
                <el-button @click="processShow = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="confirmProcess" :loading="processing">
                    ç¡®è®¤å¤„ç†
                </el-button>
            </div>
        </template>
    </el-dialog>
    
    <!-- ğŸ†• æ‰¹é‡å¤„ç†å¼¹çª— -->
    <el-dialog title="æ‰¹é‡å¤„ç†è¿è§„è®°å½•" v-model="showBatchProcessDialog" width="500px" class="batch-process-dialog">
        <div class="batch-info">
            <el-alert 
                :title="`å·²é€‰æ‹© ${multipleSelection.length} æ¡è®°å½•`" 
                type="info" 
                :closable="false"
                show-icon>
            </el-alert>
        </div>
        
        <el-form label-width="100px" style="margin-top: 20px;">
            <el-form-item label="æ‰¹é‡å¤‡æ³¨">
                <el-input 
                    type="textarea" 
                    v-model="batchProcessRemark" 
                    placeholder="è¯·è¾“å…¥æ‰¹é‡å¤„ç†è¯´æ˜ï¼ˆå¯é€‰ï¼‰..."
                    :rows="4"
                    maxlength="200"
                    show-word-limit>
                </el-input>
            </el-form-item>
        </el-form>
        
        <template #footer>
            <div class="dialog-footer">
                <el-button @click="showBatchProcessDialog = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="confirmBatchProcess" :loading="batchProcessing">
                    ç¡®è®¤æ‰¹é‡å¤„ç†
                </el-button>
            </div>
        </template>
    </el-dialog>
</template>
```

#### 4.1.5 JavaScript æ–¹æ³•

```javascript
<script setup>
import { ref, reactive } from "vue";
import { ElMessage, ElMessageBox } from "element-plus";
import { violationApi } from "@/api/violation";

// çŠ¶æ€å˜é‡
const processing = ref(false);           // å•æ¡å¤„ç†ä¸­
const batchProcessing = ref(false);      // æ‰¹é‡å¤„ç†ä¸­

// ğŸ†• è¡¨æ ¼é€‰æ‹©å˜åŒ–å¤„ç†
const handleSelectionChange = (selection) => {
    // åªå…è®¸é€‰æ‹©æœªå¤„ç†çš„è®°å½•
    multipleSelection.value = selection.filter(row => row.processStatus !== 'processed');
    
    if (selection.length > multipleSelection.value.length) {
        ElMessage.warning('å·²è¿‡æ»¤æ‰å·²å¤„ç†çš„è®°å½•');
    }
};

// ğŸ†• å•æ¡å¤„ç†
const handleProcess = (row) => {
    processForm.value = {
        id: row.id,
        plateNumber: row.plateNumber,
        violationType: row.violationType,
        processRemark: ''
    };
    processShow.value = true;
};

// ğŸ†• ç¡®è®¤å•æ¡å¤„ç†
const confirmProcess = async () => {
    try {
        processing.value = true;
        
        const response = await violationApi.processViolation(
            processForm.value.id,
            processForm.value.processRemark
        );
        
        if (response.data && response.data.code === '0') {
            ElMessage.success('å¤„ç†æˆåŠŸ');
            processShow.value = false;
            getData(); // åˆ·æ–°åˆ—è¡¨
        } else {
            ElMessage.error('å¤„ç†å¤±è´¥ï¼š' + (response.data?.msg || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        console.error('å¤„ç†å¤±è´¥:', error);
        ElMessage.error('å¤„ç†å¤±è´¥ï¼š' + (error.message || 'ç½‘ç»œé”™è¯¯'));
    } finally {
        processing.value = false;
    }
};

// ğŸ†• æ‰¹é‡å¤„ç†
const handleBatchProcess = () => {
    if (multipleSelection.value.length === 0) {
        ElMessage.warning('è¯·é€‰æ‹©è¦å¤„ç†çš„è®°å½•');
        return;
    }
    
    showBatchProcessDialog.value = true;
    batchProcessRemark.value = '';
};

// ğŸ†• ç¡®è®¤æ‰¹é‡å¤„ç†
const confirmBatchProcess = async () => {
    try {
        batchProcessing.value = true;
        
        const violationIds = multipleSelection.value.map(row => row.id);
        
        const response = await violationApi.batchProcessViolations(
            violationIds,
            batchProcessRemark.value
        );
        
        if (response.data && response.data.code === '0') {
            const result = response.data.data;
            ElMessage.success(
                `æ‰¹é‡å¤„ç†å®Œæˆï¼æˆåŠŸ: ${result.success}æ¡ï¼Œå¤±è´¥: ${result.failed}æ¡`
            );
            showBatchProcessDialog.value = false;
            multipleSelection.value = [];
            getData(); // åˆ·æ–°åˆ—è¡¨
        } else {
            ElMessage.error('æ‰¹é‡å¤„ç†å¤±è´¥ï¼š' + (response.data?.msg || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        console.error('æ‰¹é‡å¤„ç†å¤±è´¥:', error);
        ElMessage.error('æ‰¹é‡å¤„ç†å¤±è´¥ï¼š' + (error.message || 'ç½‘ç»œé”™è¯¯'));
    } finally {
        batchProcessing.value = false;
    }
};

// ğŸ”§ ä¿®æ”¹é‡ç½®æ–¹æ³•
const handleReset = () => {
    query.plateNumber = "";
    query.ownerName = "";
    query.ownerPhone = "";
    query.location = "";
    query.violationType = "";
    query.dateRange = [];
    query.processStatus = "";      // ğŸ†• é‡ç½®å¤„ç†çŠ¶æ€
    query.processType = "";        // ğŸ†• é‡ç½®å¤„ç†æ–¹å¼
    query.pageNum = 1;
    
    getData();
};

// ğŸ”§ ä¿®æ”¹æŸ¥è¯¢æ–¹æ³•ï¼Œä¼ é€’æ–°å‚æ•°
const getData = () => {
    const params = {
        page: query.pageNum,
        size: query.pageSize,
        plateNumber: query.plateNumber,
        violationType: query.violationType,
        processStatus: query.processStatus,      // ğŸ†•
        processType: query.processType,          // ğŸ†•
        // ... å…¶ä»–å‚æ•° ...
    };
    
    violationApi.getViolations(params)
        .then((res) => {
            // å¤„ç†å“åº”æ•°æ®...
        })
        .catch((error) => {
            console.error('æŸ¥è¯¢å¤±è´¥:', error);
        });
};
</script>
```

#### 4.1.6 æ ·å¼è¡¥å……

```vue
<style lang="scss" scoped>
// å¤„ç†çŠ¶æ€å•å…ƒæ ¼æ ·å¼
.process-status-cell {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 8px;
    
    .process-type-tag {
        width: 100%;
    }
    
    .process-info {
        width: 100%;
        margin-top: 8px;
        padding: 8px;
        background: #f8fafc;
        border-radius: 4px;
        font-size: 12px;
        
        .process-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            
            &:last-child {
                margin-bottom: 0;
            }
            
            .process-label {
                color: #64748b;
                font-weight: 500;
            }
            
            .process-value {
                color: #1e293b;
                
                &.remark-text {
                    max-width: 150px;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                }
            }
        }
    }
}

// æ‰¹é‡å¤„ç†å¼¹çª—æ ·å¼
.batch-process-dialog {
    .batch-info {
        margin-bottom: 20px;
    }
}
</style>
```

### 4.2 API æ¥å£å°è£…

**æ–‡ä»¶è·¯å¾„**ï¼š`manage-front/src/api/violation.js`

```javascript
import request from '@/utils/request';

export const violationApi = {
    // åŸæœ‰æ¥å£...
    
    /**
     * ğŸ†• æ‰‹åŠ¨å¤„ç†å•æ¡è¿è§„è®°å½•
     */
    processViolation(violationId, processRemark) {
        return request({
            url: `/parking/violations/${violationId}/process`,
            method: 'post',
            params: {
                processRemark: processRemark || ''
            }
        });
    },
    
    /**
     * ğŸ†• æ‰¹é‡å¤„ç†è¿è§„è®°å½•
     */
    batchProcessViolations(violationIds, processRemark) {
        return request({
            url: '/parking/violations/batch-process',
            method: 'post',
            data: {
                violationIds: violationIds,
                processRemark: processRemark || ''
            }
        });
    },
    
    /**
     * ğŸ”§ ä¿®æ”¹æŸ¥è¯¢æ¥å£ï¼Œæ”¯æŒæ–°å‚æ•°
     */
    getViolations(params) {
        return request({
            url: '/parking/violations',
            method: 'get',
            params: {
                page: params.page || 1,
                size: params.size || 20,
                plateNumber: params.plateNumber,
                violationType: params.violationType,
                startDate: params.startDate,
                endDate: params.endDate,
                processStatus: params.processStatus,        // ğŸ†•
                processType: params.processType,            // ğŸ†•
                onlyUnprocessed: params.onlyUnprocessed     // ğŸ†•
            }
        });
    }
};
```

### 4.3 å°ç¨‹åºç«¯ä¿®æ”¹

**æ–‡ä»¶è·¯å¾„**ï¼š`violation-of-stop-inspection/pages/violation/add-violation.vue`

#### 4.3.1 æŸ¥è¯¢æ¥å£è°ƒç”¨ä¿®æ”¹

åœ¨æŸ¥è¯¢è¿è§„è®°å½•æ—¶ï¼Œæ·»åŠ  `onlyUnprocessed=true` å‚æ•°ï¼š

```javascript
// æŸ¥è¯¢è¿è§„è®°å½•ï¼ˆåªæŸ¥è¯¢æœªå¤„ç†çš„ï¼‰
async getViolationRecords(plateNumber) {
    try {
        console.log('ğŸ” [æŸ¥è¯¢è¿è§„è®°å½•] è½¦ç‰Œ:', plateNumber);
        
        const response = await violationApi.getViolationsByPlateNumber(plateNumber, {
            onlyUnprocessed: true  // ğŸ†• åªæŸ¥è¯¢æœªå¤„ç†çš„è®°å½•
        });
        
        if (response && response.data) {
            const violations = response.data.data || [];
            console.log(`âœ… [æŸ¥è¯¢æˆåŠŸ] æ‰¾åˆ° ${violations.length} æ¡æœªå¤„ç†è¿è§„è®°å½•`);
            
            // æ›´æ–°è¿è§„è®°å½•åˆ—è¡¨ï¼ˆè‡ªåŠ¨è¿‡æ»¤å·²å¤„ç†çš„ï¼‰
            this.ownerInfo.violationRecords = violations;
        }
        
    } catch (error) {
        console.error('âŒ [æŸ¥è¯¢å¤±è´¥]', error);
        uni.showToast({
            title: 'æŸ¥è¯¢è¿è§„è®°å½•å¤±è´¥',
            icon: 'none'
        });
    }
}
```

#### 4.3.2 API æ¥å£å°è£…

**æ–‡ä»¶è·¯å¾„**ï¼š`violation-of-stop-inspection/api/violation-api.js`

```javascript
/**
 * ğŸ”§ ä¿®æ”¹æ ¹æ®è½¦ç‰Œå·æŸ¥è¯¢è¿è§„è®°å½•æ¥å£
 */
async getViolationsByPlateNumber(plateNumber, options = {}) {
    try {
        const params = {
            plateNumber: plateNumber,
            onlyUnprocessed: options.onlyUnprocessed !== false  // é»˜è®¤åªæŸ¥è¯¢æœªå¤„ç†çš„
        };
        
        const response = await this.request({
            url: '/parking/violations',
            method: 'GET',
            data: params
        });
        
        return response;
    } catch (error) {
        console.error('æŸ¥è¯¢è¿è§„è®°å½•å¤±è´¥:', error);
        throw error;
    }
}
```

---

## äº”ã€å®æ–½æ­¥éª¤

### 5.1 é˜¶æ®µä¸€ï¼šæ•°æ®åº“å‡†å¤‡ï¼ˆé¢„è®¡30åˆ†é’Ÿï¼‰

1. **å¤‡ä»½æ•°æ®åº“**
   ```bash
   mysqldump -u root -p parking_db > backup_$(date +%Y%m%d).sql
   ```

2. **æ‰§è¡ŒDDLè¯­å¥**
   - æ‰§è¡Œ `2.1 violations è¡¨å­—æ®µæ–°å¢` ä¸­çš„SQLè¯­å¥
   - éªŒè¯å­—æ®µæ˜¯å¦åˆ›å»ºæˆåŠŸ
   ```sql
   DESC violations;
   ```

3. **éªŒè¯ç´¢å¼•**
   ```sql
   SHOW INDEX FROM violations;
   ```

### 5.2 é˜¶æ®µäºŒï¼šåç«¯å¼€å‘ï¼ˆé¢„è®¡4å°æ—¶ï¼‰

æŒ‰ä»¥ä¸‹é¡ºåºè¿›è¡Œï¼š

1. **å®ä½“ç±»ä¿®æ”¹**ï¼ˆ15åˆ†é’Ÿï¼‰
   - ä¿®æ”¹ `Violations.java`
   - æ·»åŠ 5ä¸ªæ–°å­—æ®µçš„getter/setter

2. **Mapperå±‚å¼€å‘**ï¼ˆ1å°æ—¶ï¼‰
   - ä¿®æ”¹ `ViolationsMapper.java` æ¥å£
   - ä¿®æ”¹ `ViolationsMapper.xml` SQLæ˜ å°„
   - ç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯SQLæ­£ç¡®æ€§

3. **Serviceå±‚å¼€å‘**ï¼ˆ1.5å°æ—¶ï¼‰
   - ä¿®æ”¹ `ViolationsService.java` æ¥å£
   - å®ç° `ViolationsServiceImpl.java` ä¸šåŠ¡é€»è¾‘
   - é‡ç‚¹å®ç°è‡ªåŠ¨æ‹‰é»‘é€»è¾‘
   - ç¼–å†™å•å…ƒæµ‹è¯•

4. **Controllerå±‚å¼€å‘**ï¼ˆ1å°æ—¶ï¼‰
   - ä¿®æ”¹ `ViolationsController.java`
   - æ·»åŠ æ‰‹åŠ¨å¤„ç†å’Œæ‰¹é‡å¤„ç†æ¥å£
   - ä¿®æ”¹æŸ¥è¯¢æ¥å£æ”¯æŒæ–°å‚æ•°
   - ä½¿ç”¨Postmanæµ‹è¯•æ¥å£

5. **é›†æˆæµ‹è¯•**ï¼ˆ30åˆ†é’Ÿï¼‰
   - æµ‹è¯•åˆ›å»ºè¿è§„è®°å½•è‡ªåŠ¨æ‹‰é»‘æµç¨‹
   - æµ‹è¯•æ‰‹åŠ¨å¤„ç†åŠŸèƒ½
   - æµ‹è¯•æ‰¹é‡å¤„ç†åŠŸèƒ½
   - æµ‹è¯•ç­›é€‰æŸ¥è¯¢åŠŸèƒ½

### 5.3 é˜¶æ®µä¸‰ï¼šåå°å‰ç«¯å¼€å‘ï¼ˆé¢„è®¡3å°æ—¶ï¼‰

1. **APIæ¥å£å°è£…**ï¼ˆ30åˆ†é’Ÿï¼‰
   - ä¿®æ”¹ `violation.js`
   - æ·»åŠ æ–°çš„APIæ–¹æ³•

2. **é¡µé¢UIå¼€å‘**ï¼ˆ1.5å°æ—¶ï¼‰
   - ä¿®æ”¹æœç´¢é¢æ¿ï¼ˆæ·»åŠ ç­›é€‰æ¡ä»¶ï¼‰
   - ä¿®æ”¹è¡¨æ ¼åˆ—ï¼ˆæ·»åŠ å¤„ç†çŠ¶æ€åˆ—ï¼‰
   - æ·»åŠ å•æ¡å¤„ç†å¼¹çª—
   - æ·»åŠ æ‰¹é‡å¤„ç†å¼¹çª—

3. **ä¸šåŠ¡é€»è¾‘å®ç°**ï¼ˆ1å°æ—¶ï¼‰
   - å®ç°è¡¨æ ¼å¤šé€‰åŠŸèƒ½
   - å®ç°å•æ¡å¤„ç†åŠŸèƒ½
   - å®ç°æ‰¹é‡å¤„ç†åŠŸèƒ½
   - å®ç°ç­›é€‰æŸ¥è¯¢åŠŸèƒ½

### 5.4 é˜¶æ®µå››ï¼šå°ç¨‹åºç«¯ä¿®æ”¹ï¼ˆé¢„è®¡30åˆ†é’Ÿï¼‰

1. **APIæ¥å£ä¿®æ”¹**ï¼ˆ15åˆ†é’Ÿï¼‰
   - ä¿®æ”¹æŸ¥è¯¢æ¥å£è°ƒç”¨
   - æ·»åŠ  `onlyUnprocessed` å‚æ•°

2. **åŠŸèƒ½æµ‹è¯•**ï¼ˆ15åˆ†é’Ÿï¼‰
   - éªŒè¯åªæ˜¾ç¤ºæœªå¤„ç†è®°å½•
   - éªŒè¯å·²å¤„ç†è®°å½•ä¸æ˜¾ç¤º

### 5.5 é˜¶æ®µäº”ï¼šé›†æˆæµ‹è¯•ï¼ˆé¢„è®¡1å°æ—¶ï¼‰

1. **åŠŸèƒ½æµ‹è¯•**
   - åˆ›å»º3æ¬¡è¿è§„ï¼ŒéªŒè¯è‡ªåŠ¨æ‹‰é»‘
   - éªŒè¯æ‰¹é‡æ ‡è®°åŠŸèƒ½
   - éªŒè¯æ‰‹åŠ¨å¤„ç†åŠŸèƒ½
   - éªŒè¯æ‰¹é‡å¤„ç†åŠŸèƒ½
   - éªŒè¯ç­›é€‰æŸ¥è¯¢åŠŸèƒ½

2. **è¾¹ç•Œæµ‹è¯•**
   - æµ‹è¯•å·²å¤„ç†è®°å½•ä¸èƒ½å†æ¬¡å¤„ç†
   - æµ‹è¯•å°ç¨‹åºç«¯ä¸æ˜¾ç¤ºå·²å¤„ç†è®°å½•
   - æµ‹è¯•åˆ†é¡µåŠŸèƒ½

3. **æ€§èƒ½æµ‹è¯•**
   - æµ‹è¯•å¤§æ•°æ®é‡ä¸‹çš„æŸ¥è¯¢æ€§èƒ½
   - æµ‹è¯•æ‰¹é‡å¤„ç†æ€§èƒ½

---

## å…­ã€æµ‹è¯•æ–¹æ¡ˆ

### 6.1 è‡ªåŠ¨æ‹‰é»‘åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•åœºæ™¯1ï¼šç´¯è®¡3æ¬¡è¿è§„è‡ªåŠ¨æ‹‰é»‘**

```
æ­¥éª¤ï¼š
1. é…ç½®ç³»ç»Ÿï¼šè®¾ç½®ç´¯è®¡è¿è§„3æ¬¡è‡ªåŠ¨æ‹‰é»‘
2. åˆ›å»ºç¬¬1æ¬¡è¿è§„è®°å½•
   - è½¦ç‰Œï¼šäº¬A12345
   - éªŒè¯ï¼šprocess_status = pending
3. åˆ›å»ºç¬¬2æ¬¡è¿è§„è®°å½•
   - è½¦ç‰Œï¼šäº¬A12345
   - éªŒè¯ï¼šprocess_status = pending
4. åˆ›å»ºç¬¬3æ¬¡è¿è§„è®°å½•
   - è½¦ç‰Œï¼šäº¬A12345
   
é¢„æœŸç»“æœï¼š
âœ… è‡ªåŠ¨æ·»åŠ åˆ°é»‘åå•
âœ… 3æ¡è¿è§„è®°å½•çš„ process_status éƒ½å˜ä¸º processed
âœ… 3æ¡è¿è§„è®°å½•çš„ process_type éƒ½ä¸º auto_blacklist
âœ… 3æ¡è¿è§„è®°å½•çš„ processed_by éƒ½ä¸º SYSTEM
âœ… 3æ¡è¿è§„è®°å½•çš„ process_remark éƒ½ä¸º "ç´¯è®¡è¿è§„3æ¬¡ï¼Œç³»ç»Ÿè‡ªåŠ¨æ‹‰é»‘"
```

**æµ‹è¯•åœºæ™¯2ï¼šä¸åŒè½¦ç‰Œäº’ä¸å½±å“**

```
æ­¥éª¤ï¼š
1. è½¦ç‰Œ äº¬A11111 è¿è§„ 2æ¬¡
2. è½¦ç‰Œ äº¬B22222 è¿è§„ 2æ¬¡
3. è½¦ç‰Œ äº¬A11111 ç¬¬3æ¬¡è¿è§„

é¢„æœŸç»“æœï¼š
âœ… ä»… äº¬A11111 è¢«æ‹‰é»‘
âœ… äº¬B22222 ä¸å—å½±å“
```

### 6.2 æ‰‹åŠ¨å¤„ç†åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•åœºæ™¯ï¼šæ‰‹åŠ¨å¤„ç†å•æ¡è®°å½•**

```
æ­¥éª¤ï¼š
1. é€‰æ‹©ä¸€æ¡æœªå¤„ç†çš„è¿è§„è®°å½•
2. ç‚¹å‡»"å¤„ç†"æŒ‰é’®
3. è¾“å…¥å¤„ç†å¤‡æ³¨ï¼š"å·²é€šçŸ¥è½¦ä¸»"
4. ç¡®è®¤å¤„ç†

é¢„æœŸç»“æœï¼š
âœ… process_status å˜ä¸º processed
âœ… process_type å˜ä¸º manual
âœ… processed_by ä¸ºå½“å‰ç®¡ç†å‘˜ç”¨æˆ·å
âœ… process_remark ä¸º "å·²é€šçŸ¥è½¦ä¸»"
âœ… processed_at ä¸ºå½“å‰æ—¶é—´
âœ… å°ç¨‹åºç«¯ä¸å†æ˜¾ç¤ºè¯¥è®°å½•
```

### 6.3 æ‰¹é‡å¤„ç†åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•åœºæ™¯ï¼šæ‰¹é‡å¤„ç†å¤šæ¡è®°å½•**

```
æ­¥éª¤ï¼š
1. å‹¾é€‰5æ¡æœªå¤„ç†çš„è¿è§„è®°å½•
2. ç‚¹å‡»"æ‰¹é‡å¤„ç†"æŒ‰é’®
3. è¾“å…¥æ‰¹é‡å¤‡æ³¨ï¼š"æ‰¹é‡å¤„ç†æµ‹è¯•"
4. ç¡®è®¤æ‰¹é‡å¤„ç†

é¢„æœŸç»“æœï¼š
âœ… 5æ¡è®°å½•çš„ process_status éƒ½å˜ä¸º processed
âœ… 5æ¡è®°å½•çš„ process_type éƒ½ä¸º manual
âœ… 5æ¡è®°å½•çš„ processed_by éƒ½ä¸ºå½“å‰ç®¡ç†å‘˜ç”¨æˆ·å
âœ… 5æ¡è®°å½•çš„ process_remark éƒ½ä¸º "æ‰¹é‡å¤„ç†æµ‹è¯•"
âœ… æç¤ºï¼š"æ‰¹é‡å¤„ç†å®Œæˆï¼æˆåŠŸ: 5æ¡ï¼Œå¤±è´¥: 0æ¡"
```

### 6.4 ç­›é€‰æŸ¥è¯¢åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•åœºæ™¯1ï¼šæŒ‰å¤„ç†çŠ¶æ€ç­›é€‰**

```
æ­¥éª¤ï¼š
1. å¤„ç†çŠ¶æ€é€‰æ‹©"æœªå¤„ç†"
2. ç‚¹å‡»æœç´¢

é¢„æœŸç»“æœï¼š
âœ… åªæ˜¾ç¤º process_status = pending çš„è®°å½•
âœ… å·²å¤„ç†çš„è®°å½•ä¸æ˜¾ç¤º
```

**æµ‹è¯•åœºæ™¯2ï¼šæŒ‰å¤„ç†æ–¹å¼ç­›é€‰**

```
æ­¥éª¤ï¼š
1. å¤„ç†çŠ¶æ€é€‰æ‹©"å·²å¤„ç†"
2. å¤„ç†æ–¹å¼é€‰æ‹©"ç³»ç»Ÿè‡ªåŠ¨æ‹‰é»‘"
3. ç‚¹å‡»æœç´¢

é¢„æœŸç»“æœï¼š
âœ… åªæ˜¾ç¤º process_status = processed ä¸” process_type = auto_blacklist çš„è®°å½•
```

### 6.5 å°ç¨‹åºç«¯æµ‹è¯•

**æµ‹è¯•åœºæ™¯ï¼šéªŒè¯åªæ˜¾ç¤ºæœªå¤„ç†è®°å½•**

```
æ­¥éª¤ï¼š
1. åœ¨å°ç¨‹åºç«¯æŸ¥è¯¢æŸä¸ªè½¦ç‰Œçš„è¿è§„è®°å½•
2. è¯¥è½¦ç‰Œæœ‰3æ¡è¿è§„è®°å½•ï¼Œå…¶ä¸­1æ¡å·²å¤„ç†

é¢„æœŸç»“æœï¼š
âœ… å°ç¨‹åºç«¯åªæ˜¾ç¤º2æ¡æœªå¤„ç†çš„è®°å½•
âœ… å·²å¤„ç†çš„è®°å½•ä¸æ˜¾ç¤º
```

### 6.6 è¾¹ç•Œæµ‹è¯•

**æµ‹è¯•åœºæ™¯1ï¼šé‡å¤å¤„ç†é˜²æŠ¤**

```
æ­¥éª¤ï¼š
1. æ‰‹åŠ¨å¤„ç†ä¸€æ¡è®°å½•
2. å†æ¬¡å°è¯•å¤„ç†åŒä¸€æ¡è®°å½•

é¢„æœŸç»“æœï¼š
âœ… ç³»ç»Ÿæç¤ºï¼š"å¤„ç†å¤±è´¥ï¼Œè®°å½•å¯èƒ½ä¸å­˜åœ¨æˆ–å·²è¢«å¤„ç†"
âœ… è®°å½•çŠ¶æ€ä¸å˜
```

**æµ‹è¯•åœºæ™¯2ï¼šè‡ªåŠ¨æ‹‰é»‘åå†è¿è§„**

```
æ­¥éª¤ï¼š
1. æŸè½¦ç‰Œç´¯è®¡3æ¬¡è¿è§„ï¼Œå·²è¢«è‡ªåŠ¨æ‹‰é»‘
2. è¯¥è½¦ç‰Œå†æ¬¡è¿è§„ï¼ˆç¬¬4æ¬¡ï¼‰

é¢„æœŸç»“æœï¼š
âœ… æ–°çš„è¿è§„è®°å½•æ­£å¸¸åˆ›å»º
âœ… process_status = pendingï¼ˆå› ä¸ºæ˜¯æ–°è®°å½•ï¼‰
âœ… ä¸ä¼šå†æ¬¡è§¦å‘æ‹‰é»‘ï¼ˆå·²åœ¨é»‘åå•ä¸­ï¼‰
```

---

## ä¸ƒã€æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ

### 7.1 æ€§èƒ½ä¼˜åŒ–

1. **æ•°æ®åº“ç´¢å¼•**
   - å·²åœ¨ `process_status` å’Œ `process_type` å­—æ®µæ·»åŠ ç´¢å¼•
   - å¤åˆç´¢å¼• `idx_plate_process` ä¼˜åŒ–æŒ‰è½¦ç‰Œ+çŠ¶æ€æŸ¥è¯¢

2. **æ‰¹é‡æ“ä½œä¼˜åŒ–**
   - æ‰¹é‡æ›´æ–°ä½¿ç”¨å•æ¡SQLï¼Œå‡å°‘æ•°æ®åº“äº¤äº’
   - äº‹åŠ¡æ§åˆ¶ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

3. **æŸ¥è¯¢ä¼˜åŒ–**
   - å°ç¨‹åºç«¯é»˜è®¤åªæŸ¥è¯¢æœªå¤„ç†è®°å½•ï¼Œå‡å°‘æ•°æ®é‡
   - åˆ†é¡µæŸ¥è¯¢é¿å…ä¸€æ¬¡åŠ è½½å¤§é‡æ•°æ®

### 7.2 å®‰å…¨æ€§è€ƒè™‘

1. **æƒé™æ§åˆ¶**
   - æ‰‹åŠ¨å¤„ç†åŠŸèƒ½ä»…ç®¡ç†å‘˜å¯ç”¨
   - æ‰¹é‡å¤„ç†åŠŸèƒ½ä»…ç®¡ç†å‘˜å¯ç”¨
   - è®°å½•æ“ä½œå‘˜ä¿¡æ¯ï¼Œæ”¯æŒå®¡è®¡

2. **æ•°æ®éªŒè¯**
   - éªŒè¯è¿è§„è®°å½•IDå­˜åœ¨æ€§
   - éªŒè¯å¤„ç†çŠ¶æ€ï¼Œé˜²æ­¢é‡å¤å¤„ç†
   - éªŒè¯æ“ä½œæƒé™

### 7.3 ç”¨æˆ·ä½“éªŒ

1. **å‹å¥½æç¤º**
   - å¤„ç†æˆåŠŸç»™äºˆæ˜ç¡®æç¤º
   - æ‰¹é‡å¤„ç†æ˜¾ç¤ºæˆåŠŸ/å¤±è´¥æ•°é‡
   - ç­›é€‰æ— ç»“æœæ—¶å‹å¥½æç¤º

2. **æ“ä½œä¾¿æ·æ€§**
   - æ”¯æŒæ‰¹é‡å‹¾é€‰
   - æ”¯æŒä¸€é”®æ‰¹é‡å¤„ç†
   - å¤‡æ³¨å­—æ®µå¯é€‰ï¼Œä¸å¼ºåˆ¶å¡«å†™

### 7.4 å¯æ‰©å±•æ€§

1. **çŠ¶æ€å­—æ®µè®¾è®¡**
   - ä½¿ç”¨å­—ç¬¦ä¸²ç±»å‹ï¼Œä¾¿äºæ‰©å±•æ–°çŠ¶æ€
   - é¢„ç•™äº†å¤‡æ³¨å­—æ®µï¼Œæ”¯æŒæ›´å¤šä¿¡æ¯è®°å½•

2. **å¤„ç†æ–¹å¼æ‰©å±•**
   - å½“å‰æ”¯æŒ `auto_blacklist` å’Œ `manual`
   - æœªæ¥å¯æ‰©å±•ï¼š`auto_timeout`ï¼ˆè¶…æ—¶è‡ªåŠ¨å¤„ç†ï¼‰ã€`batch`ï¼ˆæ‰¹é‡å¤„ç†ï¼‰ç­‰

---

## å…«ã€é™„å½•

### 8.1 æ•°æ®åº“å®Œæ•´DDL

```sql
-- æ·»åŠ å¤„ç†ç›¸å…³å­—æ®µ
ALTER TABLE violations 
ADD COLUMN process_status VARCHAR(20) DEFAULT 'pending' COMMENT 'å¤„ç†çŠ¶æ€: pending-æœªå¤„ç†, processed-å·²å¤„ç†',
ADD COLUMN process_type VARCHAR(50) DEFAULT NULL COMMENT 'å¤„ç†æ–¹å¼: auto_blacklist-ç³»ç»Ÿè‡ªåŠ¨æ‹‰é»‘, manual-æ‰‹åŠ¨å¤„ç†',
ADD COLUMN processed_at TIMESTAMP NULL DEFAULT NULL COMMENT 'å¤„ç†æ—¶é—´',
ADD COLUMN processed_by VARCHAR(255) DEFAULT NULL COMMENT 'å¤„ç†äººï¼ˆç”¨æˆ·åæˆ–SYSTEMï¼‰',
ADD COLUMN process_remark TEXT DEFAULT NULL COMMENT 'å¤„ç†å¤‡æ³¨è¯´æ˜';

-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_process_status ON violations(process_status);
CREATE INDEX idx_process_type ON violations(process_type);
CREATE INDEX idx_plate_process ON violations(plate_number, process_status);

-- éªŒè¯è¡¨ç»“æ„
DESC violations;
SHOW INDEX FROM violations;
```

### 8.2 APIæ¥å£æ–‡æ¡£

#### 8.2.1 æ‰‹åŠ¨å¤„ç†è¿è§„è®°å½•

**æ¥å£åœ°å€**ï¼š`POST /parking/violations/{id}/process`

**è¯·æ±‚å‚æ•°**ï¼š
- Pathå‚æ•°ï¼š`id` - è¿è§„è®°å½•IDï¼ˆå¿…å¡«ï¼‰
- Queryå‚æ•°ï¼š`processRemark` - å¤„ç†å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
    "code": "0",
    "msg": "success",
    "data": true
}
```

#### 8.2.2 æ‰¹é‡å¤„ç†è¿è§„è®°å½•

**æ¥å£åœ°å€**ï¼š`POST /parking/violations/batch-process`

**è¯·æ±‚ä½“**ï¼š
```json
{
    "violationIds": [1, 2, 3],
    "processRemark": "æ‰¹é‡å¤„ç†å¤‡æ³¨"
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
    "code": "0",
    "msg": "success",
    "data": {
        "total": 3,
        "success": 3,
        "failed": 0
    }
}
```

#### 8.2.3 æŸ¥è¯¢è¿è§„è®°å½•ï¼ˆæ”¯æŒç­›é€‰ï¼‰

**æ¥å£åœ°å€**ï¼š`GET /parking/violations`

**è¯·æ±‚å‚æ•°**ï¼š
- `page` - é¡µç ï¼ˆé»˜è®¤1ï¼‰
- `size` - é¡µå¤§å°ï¼ˆé»˜è®¤20ï¼‰
- `plateNumber` - è½¦ç‰Œå·ï¼ˆå¯é€‰ï¼‰
- `processStatus` - å¤„ç†çŠ¶æ€ï¼špending/processedï¼ˆå¯é€‰ï¼‰
- `processType` - å¤„ç†æ–¹å¼ï¼šauto_blacklist/manualï¼ˆå¯é€‰ï¼‰
- `onlyUnprocessed` - æ˜¯å¦ä»…æŸ¥è¯¢æœªå¤„ç†ï¼štrue/falseï¼ˆå¯é€‰ï¼Œå°ç¨‹åºç«¯ä½¿ç”¨ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
    "code": "0",
    "msg": "success",
    "data": {
        "records": [...],
        "total": 100,
        "size": 20,
        "current": 1,
        "pages": 5
    }
}
```

---

## ä¹ã€å¸¸è§é—®é¢˜FAQ

### Q1ï¼šå¦‚æœé…ç½®çš„è¿è§„æ¬¡æ•°é˜ˆå€¼æ”¹å˜äº†ï¼Œå·²å­˜åœ¨çš„è¿è§„è®°å½•æ€ä¹ˆå¤„ç†ï¼Ÿ

**A**ï¼šé…ç½®å˜æ›´åªå½±å“æ–°åˆ›å»ºçš„è¿è§„è®°å½•ã€‚å·²å­˜åœ¨çš„è¿è§„è®°å½•ä¸ä¼šé‡æ–°è®¡ç®—ã€‚å¦‚æœéœ€è¦é‡æ–°è¯„ä¼°ï¼Œå¯ä»¥ï¼š
1. æ‰‹åŠ¨å¤„ç†å·²æ‹‰é»‘ä½†ä¸åº”æ‹‰é»‘çš„è®°å½•
2. æˆ–å¼€å‘ä¸€ä¸ªç®¡ç†å·¥å…·æ‰¹é‡é‡æ–°è¯„ä¼°

### Q2ï¼šè‡ªåŠ¨æ‹‰é»‘åï¼Œè¯¥è½¦ç‰Œè¿˜èƒ½è¿›å…¥ç³»ç»Ÿå—ï¼Ÿ

**A**ï¼šå–å†³äºé»‘åå•çš„æ£€æŸ¥é€»è¾‘ã€‚é€šå¸¸ï¼š
- é»‘åå•è½¦è¾†æ— æ³•é¢„çº¦åœè½¦
- å¦‚æœå¼ºè¡Œè¿›å…¥å¹¶è¢«æ£€æµ‹åˆ°ï¼Œä¼šç«‹å³åˆ›å»ºæ–°çš„è¿è§„è®°å½•
- å»ºè®®åœ¨å…¥åœºæ£€æŸ¥æ—¶æ‹¦æˆªé»‘åå•è½¦è¾†

### Q3ï¼šæ‰¹é‡å¤„ç†æ—¶ï¼Œå¦‚æœéƒ¨åˆ†è®°å½•å·²è¢«å¤„ç†æ€ä¹ˆåŠï¼Ÿ

**A**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨è·³è¿‡å·²å¤„ç†çš„è®°å½•ï¼Œåªå¤„ç†æœªå¤„ç†çš„è®°å½•ã€‚æ‰¹é‡å¤„ç†å®Œæˆåä¼šæç¤ºï¼š
- æˆåŠŸå¤„ç†çš„æ•°é‡
- å¤±è´¥/è·³è¿‡çš„æ•°é‡

### Q4ï¼šå°ç¨‹åºç«¯ä¸ºä»€ä¹ˆä¸æ˜¾ç¤ºå·²å¤„ç†çš„è®°å½•ï¼Ÿ

**A**ï¼šä¸šåŠ¡é€»è¾‘è€ƒè™‘ï¼š
- å°ç¨‹åºç«¯ä¸»è¦ç”¨äºæŸ¥çœ‹å½“å‰éœ€è¦å…³æ³¨çš„è¿è§„
- å·²å¤„ç†çš„è®°å½•ä¸éœ€è¦å†æ¬¡æé†’è½¦ä¸»
- å¦‚éœ€æŸ¥çœ‹å®Œæ•´å†å²ï¼Œå¯åœ¨åå°ç®¡ç†ç«¯æŸ¥è¯¢

### Q5ï¼šå¤„ç†å¤‡æ³¨å­—æ®µæ˜¯å¦å¿…å¡«ï¼Ÿ

**A**ï¼šä¸æ˜¯å¿…å¡«ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨è®¾ç½®é»˜è®¤å¤‡æ³¨ï¼š
- æ‰‹åŠ¨å¤„ç†ï¼šé»˜è®¤ä¸º "æ‰‹åŠ¨å¤„ç†"
- ç³»ç»Ÿè‡ªåŠ¨æ‹‰é»‘ï¼šè‡ªåŠ¨ç”Ÿæˆ "ç´¯è®¡è¿è§„Næ¬¡ï¼Œç³»ç»Ÿè‡ªåŠ¨æ‹‰é»‘"

---

## åã€æ€»ç»“

æœ¬æŠ€æœ¯æ–¹æ¡ˆå®ç°äº†è¿è§„è®°å½•å¤„ç†åŠŸèƒ½çš„å®Œæ•´é—­ç¯ï¼š

### âœ… æ ¸å¿ƒåŠŸèƒ½
1. **ç³»ç»Ÿè‡ªåŠ¨æ‹‰é»‘**ï¼šç´¯è®¡Næ¬¡è¿è§„è‡ªåŠ¨æ‹‰é»‘ï¼Œæ‰¹é‡æ ‡è®°æ‰€æœ‰è¿è§„è®°å½•ä¸ºå·²å¤„ç†
2. **æ‰‹åŠ¨å¤„ç†**ï¼šç®¡ç†å‘˜å¯å•ç‹¬å¤„ç†è¿è§„è®°å½•
3. **æ‰¹é‡å¤„ç†**ï¼šç®¡ç†å‘˜å¯æ‰¹é‡é€‰æ‹©å¤šæ¡è®°å½•ä¸€é”®å¤„ç†
4. **æ™ºèƒ½ç­›é€‰**ï¼šæ”¯æŒæŒ‰å¤„ç†çŠ¶æ€ã€å¤„ç†æ–¹å¼ç­›é€‰æŸ¥è¯¢
5. **å°ç¨‹åºä¼˜åŒ–**ï¼šå°ç¨‹åºç«¯è‡ªåŠ¨è¿‡æ»¤å·²å¤„ç†è®°å½•

### âœ… æŠ€æœ¯ç‰¹ç‚¹
1. **æ•°æ®å®Œæ•´æ€§**ï¼šè¿è§„è®°å½•æ°¸ä¸åˆ é™¤ï¼Œé€šè¿‡çŠ¶æ€æ ‡è®°ç®¡ç†
2. **å¯è¿½æº¯æ€§**ï¼šå®Œæ•´è®°å½•å¤„ç†æ—¶é—´ã€å¤„ç†äººã€å¤„ç†æ–¹å¼
3. **é«˜æ€§èƒ½**ï¼šåˆç†çš„ç´¢å¼•è®¾è®¡ï¼Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
4. **æ˜“æ‰©å±•**ï¼šå­—æ®µè®¾è®¡æ”¯æŒæœªæ¥åŠŸèƒ½æ‰©å±•

### âœ… å®æ–½ä¿éšœ
1. **è¯¦ç»†æ­¥éª¤**ï¼šåˆ†é˜¶æ®µå®æ–½ï¼Œæ¯ä¸ªé˜¶æ®µæœ‰æ˜ç¡®çš„æ—¶é—´é¢„ä¼°
2. **å®Œæ•´æµ‹è¯•**ï¼šè¦†ç›–åŠŸèƒ½æµ‹è¯•ã€è¾¹ç•Œæµ‹è¯•ã€æ€§èƒ½æµ‹è¯•
3. **æ–‡æ¡£å®Œå–„**ï¼šAPIæ–‡æ¡£ã€FAQã€æ³¨æ„äº‹é¡¹ä¸€åº”ä¿±å…¨

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-31  
**æœ€åæ›´æ–°**ï¼š2025-01-31  
**ç»´æŠ¤äººå‘˜**ï¼šå¼€å‘å›¢é˜Ÿ 